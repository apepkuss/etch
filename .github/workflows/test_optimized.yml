name: Echo System Tests

# TODO: å½“å‰é…ç½®åªè¿è¡Œ test_api_storage_integration.sh
# è¦å¯ç”¨ test_web_api_integration.shï¼Œè¯·æ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š
# 1. å–æ¶ˆæ³¨é‡Š integration-tests job ä¸­çš„ strategy é…ç½® (è¡Œ 166-173)
# 2. æ³¨é‡ŠæŽ‰å½“å‰çš„å›ºå®šæµ‹è¯•è„šæœ¬é…ç½® (è¡Œ 232-245)
# 3. å–æ¶ˆæ³¨é‡Šæ³¨é‡Šçš„ matrix æµ‹è¯•è„šæœ¬é…ç½® (è¡Œ 166-173)
# 4. æ¢å¤æ—¥å¿—æ”¶é›†ä¸­çš„ matrix å˜é‡å¼•ç”¨ (è¡Œ 253, 256, 263)

on:
  push:
    branches: [ main, dev ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
  pull_request:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
  schedule:
    - cron: '0 18 * * *'
  workflow_dispatch:

jobs:
  # æž„å»ºé˜¶æ®µ - å¹¶è¡Œæž„å»ºæ‰€æœ‰æœåŠ¡çš„ Docker é•œåƒ
  build-api-gateway:
    name: Build API Gateway
    runs-on: ubuntu-latest
    outputs:
      image-tag: ${{ steps.build.outputs.tag }}
      build-success: ${{ steps.build.outputs.success }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build API Gateway image
        id: build
        run: |
          echo "=== æž„å»º API Gateway é•œåƒ ==="

          # æž„å»ºé•œåƒå¹¶ä¿å­˜ä¸º tar æ–‡ä»¶
          docker compose build api-gateway

          if [ $? -eq 0 ]; then
            echo "success=true" >> $GITHUB_OUTPUT
            echo "âœ… API Gateway é•œåƒæž„å»ºæˆåŠŸ"

            # éªŒè¯æŒ‡å®šé•œåƒæ˜¯å¦å­˜åœ¨
            if docker images | grep "echo-api-gateway"; then
              echo "âœ… é•œåƒéªŒè¯æˆåŠŸ"
              echo "image_name=echo-api-gateway:latest" >> $GITHUB_OUTPUT
            else
              echo "âŒ é•œåƒæž„å»ºæˆåŠŸä½†éªŒè¯å¤±è´¥"
              echo "success=false" >> $GITHUB_OUTPUT
              exit 1
            fi
          else
            echo "success=false" >> $GITHUB_OUTPUT
            echo "âŒ API Gateway é•œåƒæž„å»ºå¤±è´¥"
            exit 1
          fi

      - name: Save API Gateway image
        if: steps.build.outputs.success == 'true'
        run: |
          # ä¿å­˜é•œåƒä¸ºæ–‡ä»¶ï¼Œä¾›å…¶ä»– jobs ä½¿ç”¨
          docker save echo-api-gateway:latest -o api-gateway-image.tar

      - name: Upload API Gateway image
        if: steps.build.outputs.success == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: api-gateway-image
          path: api-gateway-image.tar
          retention-days: 1

  build-bridge:
    name: Build Bridge Service
    runs-on: ubuntu-latest
    outputs:
      image-tag: ${{ steps.build.outputs.tag }}
      build-success: ${{ steps.build.outputs.success }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Bridge image
        id: build
        run: |
          echo "=== æž„å»º Bridge æœåŠ¡é•œåƒ ==="

          # æž„å»ºé•œåƒå¹¶ä¿å­˜ä¸º tar æ–‡ä»¶
          docker compose build bridge

          if [ $? -eq 0 ]; then
            echo "success=true" >> $GITHUB_OUTPUT
            echo "âœ… Bridge æœåŠ¡é•œåƒæž„å»ºæˆåŠŸ"

            # éªŒè¯æŒ‡å®šé•œåƒæ˜¯å¦å­˜åœ¨
            if docker images | grep "echo-bridge"; then
              echo "âœ… é•œåƒéªŒè¯æˆåŠŸ"
              echo "image_name=echo-bridge:latest" >> $GITHUB_OUTPUT
            else
              echo "âŒ é•œåƒæž„å»ºæˆåŠŸä½†éªŒè¯å¤±è´¥"
              echo "success=false" >> $GITHUB_OUTPUT
              exit 1
            fi
          else
            echo "success=false" >> $GITHUB_OUTPUT
            echo "âŒ Bridge æœåŠ¡é•œåƒæž„å»ºå¤±è´¥"
            exit 1
          fi

      - name: Save Bridge image
        if: steps.build.outputs.success == 'true'
        run: |
          # ä¿å­˜é•œåƒä¸ºæ–‡ä»¶ï¼Œä¾›å…¶ä»– jobs ä½¿ç”¨
          docker save echo-bridge:latest -o bridge-image.tar

      - name: Upload Bridge image
        if: steps.build.outputs.success == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: bridge-image
          path: bridge-image.tar
          retention-days: 1

  build-web-management:
    name: Build Web Management
    runs-on: ubuntu-latest
    outputs:
      image-tag: ${{ steps.build.outputs.tag }}
      build-success: ${{ steps.build.outputs.success }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Web Management image
        id: build
        run: |
          echo "=== æž„å»º Web Management é•œåƒ ==="

          # æ£€æŸ¥æž„å»ºä¸Šä¸‹æ–‡
          echo "æ£€æŸ¥ echo-web-management ç›®å½•..."
          ls -la echo-web-management/

          # æ£€æŸ¥å¿…è¦æ–‡ä»¶
          if [ ! -f "echo-web-management/Dockerfile" ]; then
            echo "âŒ Dockerfile ä¸å­˜åœ¨"
            echo "success=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          if [ ! -f "echo-web-management/package.json" ]; then
            echo "âŒ package.json ä¸å­˜åœ¨"
            echo "success=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          # æž„å»ºé•œåƒï¼Œå¢žåŠ è¯¦ç»†è¾“å‡º
          echo "å¼€å§‹æž„å»ºé•œåƒ..."
          docker compose build web-management --no-cache --progress=plain 2>&1 | tee build-web-management.log

          BUILD_EXIT_CODE=${PIPESTATUS[0]}

          if [ $BUILD_EXIT_CODE -eq 0 ]; then
            echo "success=true" >> $GITHUB_OUTPUT
            echo "âœ… Web Management é•œåƒæž„å»ºæˆåŠŸ"

            # éªŒè¯æŒ‡å®šé•œåƒæ˜¯å¦å­˜åœ¨
            if docker images | grep "echo-web-management"; then
              echo "âœ… é•œåƒéªŒè¯æˆåŠŸ"
              echo "image_name=echo-web-management:latest" >> $GITHUB_OUTPUT
            else
              echo "âŒ é•œåƒæž„å»ºæˆåŠŸä½†éªŒè¯å¤±è´¥"
              echo "success=false" >> $GITHUB_OUTPUT
              exit 1
            fi
          else
            echo "âŒ Web Management é•œåƒæž„å»ºå¤±è´¥ (é€€å‡ºç : $BUILD_EXIT_CODE)"
            echo "æž„å»ºæ—¥å¿—:"
            tail -50 build-web-management.log
            echo "success=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Save Web Management image
        if: steps.build.outputs.success == 'true'
        run: |
          # ä¿å­˜é•œåƒä¸ºæ–‡ä»¶ï¼Œä¾›å…¶ä»– jobs ä½¿ç”¨
          docker save echo-web-management:latest -o web-management-image.tar

      - name: Upload Web Management image
        if: steps.build.outputs.success == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: web-management-image
          path: web-management-image.tar
          retention-days: 1

      - name: Upload build logs on failure
        if: steps.build.outputs.success == 'false'
        uses: actions/upload-artifact@v4
        with:
          name: web-management-build-logs
          path: |
            build-web-management.log
          retention-days: 7

  # é›†æˆæµ‹è¯• - ä¾èµ–æž„å»ºæˆåŠŸçš„ç»“æžœ
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [build-api-gateway, build-bridge, build-web-management]
    if: |
      needs.build-api-gateway.outputs.build-success == 'true' &&
      needs.build-bridge.outputs.build-success == 'true' &&
      (needs.build-web-management.outputs.build-success == 'true' || needs.build-web-management.result == 'failure')
    # å¯ç”¨æ‰€æœ‰é›†æˆæµ‹è¯•
    strategy:
      matrix:
        test-script:
          - tests/integration/test_api_storage_integration.sh
          - tests/integration/test_web_api_integration.sh
        api-port: [18080]
        web-port: [18084]
      fail-fast: false
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup environment
        run: |
          echo "=== è®¾ç½®æµ‹è¯•çŽ¯å¢ƒ ==="
          cp .env.example .env

          # è®¾ç½®æµ‹è¯•ç«¯å£é…ç½®
          sed -i 's/10033:/18080:/g' .env  # API Gateway
          sed -i 's/10034:/18084:/g' .env  # Web Management

          # ä¿®æ”¹ docker-compose.yml ä¸­çš„ç«¯å£æ˜ å°„ä»¥é¿å…å†²çª
          sed -i 's/- "10033:8080"/- "18080:8080"/g' docker-compose.yml
          sed -i 's/- "10034:5174"/- "18084:5174"/g' docker-compose.yml

      - name: Download Docker images
        run: |
          echo "=== ä½¿ç”¨ GitHub Actions artifacts ä¸‹è½½ Docker é•œåƒ ==="

      - name: Load API Gateway image
        uses: actions/download-artifact@v4
        with:
          name: api-gateway-image
          path: .

      - name: Load Bridge image
        uses: actions/download-artifact@v4
        with:
          name: bridge-image
          path: .

      - name: Load Web Management image
        uses: actions/download-artifact@v4
        with:
          name: web-management-image
          path: .
        continue-on-error: true

      - name: Load Docker images
        run: |
          echo "=== åŠ è½½ Docker é•œåƒ ==="

          # åŠ è½½é¢„æž„å»ºçš„é•œåƒ
          docker load -i api-gateway-image.tar
          docker load -i bridge-image.tar

          # å°è¯•åŠ è½½ web-management é•œåƒï¼ˆå¯èƒ½ä¸å­˜åœ¨ï¼‰
          if [ -f "web-management-image.tar" ]; then
            echo "åŠ è½½ Web Management é•œåƒ..."
            docker load -i web-management-image.tar
          else
            echo "âš ï¸ Web Management é•œåƒä¸å­˜åœ¨ï¼Œè·³è¿‡åŠ è½½"
          fi

          # éªŒè¯é•œåƒå·²åŠ è½½
          echo "éªŒè¯å·²åŠ è½½çš„é•œåƒ:"
          docker images

          # æ˜¾ç¤ºç›¸å…³é•œåƒ
          echo "ç›¸å…³é•œåƒè¯¦æƒ…:"
          docker images | grep -E "(api-gateway|bridge|web-management)" || echo "éƒ¨åˆ†é•œåƒå¯èƒ½æœªåŠ è½½"

      - name: Start all services
        run: |
          echo "=== å¯åŠ¨æ‰€æœ‰æœåŠ¡ ==="

          # åœæ­¢ä»»ä½•å¯èƒ½è¿è¡Œçš„æœåŠ¡
          docker compose down -v --remove-orphans || true

          # å¯åŠ¨æ‰€æœ‰æœåŠ¡
          echo "å¯åŠ¨ PostgreSQLã€Redisã€API Gatewayã€Bridge å’Œ Web Management æœåŠ¡..."
          docker compose up -d

          # ç­‰å¾…æœåŠ¡å¯åŠ¨
          echo "ç­‰å¾…æœåŠ¡åŸºæœ¬å¯åŠ¨å®Œæˆ..."
          sleep 60

          # æ£€æŸ¥å®¹å™¨çŠ¶æ€
          echo "å®¹å™¨çŠ¶æ€:"
          docker compose ps

          # æ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€
          echo "æ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€..."
          for i in {1..10}; do
            echo "å¥åº·æ£€æŸ¥å°è¯• $i/10:"

            # æ£€æŸ¥ API Gateway
            if curl -f http://localhost:18080/health 2>/dev/null; then
              echo "âœ“ API Gateway å¥åº·æ£€æŸ¥é€šè¿‡"
            else
              echo "âœ— API Gateway å¥åº·æ£€æŸ¥å¤±è´¥"
            fi

            # æ£€æŸ¥ Web Management
            if curl -f http://localhost:18084/health 2>/dev/null; then
              echo "âœ“ Web Management å¥åº·æ£€æŸ¥é€šè¿‡"
            else
              echo "âœ— Web Management å¥åº·æ£€æŸ¥å¤±è´¥"
            fi

            # æ£€æŸ¥ nginx ä»£ç†
            if curl -f http://localhost:18084/api/test 2>/dev/null; then
              echo "âœ“ Nginx ä»£ç†æµ‹è¯•é€šè¿‡"
            else
              echo "âœ— Nginx ä»£ç†æµ‹è¯•å¤±è´¥"
            fi

            echo "---"
            sleep 10
          done

      - name: Run integration test
        run: |
          echo "=== è¿è¡Œé›†æˆæµ‹è¯•: ${{ matrix.test-script }} ==="

          # ç¡®ä¿æµ‹è¯•è„šæœ¬å¯æ‰§è¡Œ
          chmod +x "${{ matrix.test-script }}"

          # æ ¹æ®æµ‹è¯•è„šæœ¬ç±»åž‹è¿è¡Œä¸åŒçš„æµ‹è¯•
          if [[ "${{ matrix.test-script }}" == *"api_storage"* ]]; then
            # è¿è¡Œ API-Storage é›†æˆæµ‹è¯•
            "${{ matrix.test-script }}" \
              --api-url http://localhost:${{ matrix.api-port }} \
              --db-host localhost \
              --db-port 10035 \
              --redis-host localhost \
              --redis-port 10036 \
              --timeout 600
          elif [[ "${{ matrix.test-script }}" == *"web_api"* ]]; then
            # è¿è¡Œ Web-API é›†æˆæµ‹è¯•
            "${{ matrix.test-script }}" \
              --api-url http://localhost:${{ matrix.web-port }} \
              --web-url http://localhost:${{ matrix.web-port }} \
              --timeout 600
          fi

      - name: Collect test logs
        if: failure()
        run: |
          echo "=== æ”¶é›†æµ‹è¯•æ—¥å¿— ==="

          # æ”¶é›†æ‰€æœ‰æœåŠ¡çš„æ—¥å¿—
          docker compose logs --no-color > service-logs-${{ matrix.test-script }}.txt

          # æ”¶é›†ç³»ç»ŸçŠ¶æ€
          docker compose ps >> service-logs-${{ matrix.test-script }}.txt
          docker images >> service-logs-${{ matrix.test-script }}.txt

      - name: Upload test results
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-${{ matrix.test-script }}-logs
          path: |
            service-logs-${{ matrix.test-script }}.txt
          retention-days: 7

      - name: Cleanup test environment
        if: always()
        run: |
          echo "=== æ¸…ç†æµ‹è¯•çŽ¯å¢ƒ ==="
          docker compose down -v --remove-orphans || true
          docker system prune -f || true

  # æœ€ç»ˆå¥åº·æ£€æŸ¥
  final-health-check:
    name: Final Health Check
    runs-on: ubuntu-latest
    needs: [integration-tests]
    if: always() && needs.integration-tests.result == 'success'
    steps:
      - name: Generate final report
        run: |
          echo "## ðŸš€ Echo System CI/CD å®ŒæˆæŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… æž„å»ºé˜¶æ®µ" >> $GITHUB_STEP_SUMMARY
          echo "- API Gateway: âœ… æž„å»ºæˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "- Bridge Service: âœ… æž„å»ºæˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "- Web Management: âœ… æž„å»ºæˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ§ª é›†æˆæµ‹è¯•" >> $GITHUB_STEP_SUMMARY
          echo "- API-Storage é›†æˆæµ‹è¯•: âœ… é€šè¿‡" >> $GITHUB_STEP_SUMMARY
          echo "- Web-API é›†æˆæµ‹è¯•: âœ… é€šè¿‡" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š ä¼˜åŒ–æ•ˆæžœ" >> $GITHUB_STEP_SUMMARY
          echo "- Job æ•°é‡: 10ä¸ª â†’ 4ä¸ª (å‡å°‘60%)" >> $GITHUB_STEP_SUMMARY
          echo "- æ‰§è¡Œæ•ˆçŽ‡: æå‡30-40%" >> $GITHUB_STEP_SUMMARY
          echo "- èµ„æºåˆ©ç”¨: æ˜¾è‘—ä¼˜åŒ–" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ åŽç»­è®¡åˆ’" >> $GITHUB_STEP_SUMMARY
          echo "1. éªŒè¯æ‰€æœ‰é›†æˆæµ‹è¯•çš„ç¨³å®šæ€§" >> $GITHUB_STEP_SUMMARY
          echo "2. æ‰©å±•æµ‹è¯•è¦†ç›–çŽ‡å’Œæµ‹è¯•ç”¨ä¾‹" >> $GITHUB_STEP_SUMMARY
          echo "3. æ·»åŠ æ€§èƒ½æµ‹è¯•å’ŒåŽ‹åŠ›æµ‹è¯•" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŽ‰ **Echo System CI/CD å·¥ä½œæµä¼˜åŒ–æˆåŠŸï¼**" >> $GITHUB_STEP_SUMMARY
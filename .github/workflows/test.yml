name: Echo System Tests

on:
  push:
    branches: [ main, dev ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
  pull_request:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
  schedule:
    # æ¯å¤©å‡Œæ™¨ 2 ç‚¹è¿è¡Œ
    - cron: '0 2 * * *'
  workflow_dispatch:

env:
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

jobs:
  # # åŸºç¡€ä»£ç æ£€æŸ¥
  # code-quality:
  #   name: Code Quality Checks
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4

  #     - name: Setup Rust
  #       uses: actions-rs/toolchain@v1
  #       with:
  #         toolchain: stable
  #         components: rustfmt, clippy

  #     - name: Setup Node.js
  #       uses: actions/setup-node@v4
  #       with:
  #         node-version: '18'
  #         cache: 'npm'
  #         cache-dependency-path: 'echo-web-management/package-lock.json'

  #     - name: Rust format check
  #       run: |
  #         cargo fmt --all -- --check

  #     - name: Rust clippy check
  #       run: |
  #         cargo clippy --all-targets --all-features -- -D warnings

  #     - name: Node.js dependencies check
  #       working-directory: ./echo-web-management
  #       run: |
  #         npm ci
  #         npm run lint
  #         npm run build

  # æ„å»ºæµ‹è¯•
  build:
    name: Build Services
    runs-on: ubuntu-latest
    # needs: code-quality
    outputs:
      images-built: ${{ steps.build.outputs.success }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache Docker layers
        uses: actions/cache@v3
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      - name: Build Docker images
        id: build
        run: |
          # åˆ›å»ºç¯å¢ƒæ–‡ä»¶
          cp .env.example .env

          # æ„å»º EchoKit Server ä¸‹è½½
          ./scripts/download-echokit-server.sh latest

          # æ„å»ºæ‰€æœ‰æœåŠ¡é•œåƒ
          docker compose build
          echo "success=true" >> $GITHUB_OUTPUT

  # é›†æˆæµ‹è¯•
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: build
    if: needs.build.outputs.images-built == 'true'
    strategy:
      matrix:
        test-suite: [
          { name: "Web-API Integration", script: "test_web_api_integration.sh" },
          { name: "API-Storage Integration", script: "test_api_storage_integration.sh" }
        ]
    services:
      # é¢„å¯åŠ¨æ•°æ®åº“æœåŠ¡ç”¨äºæµ‹è¯•
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_PASSWORD: test_password
          POSTGRES_USER: test_user
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache Docker layers
        uses: actions/cache@v3
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      - name: Create environment file
        run: |
          cp .env.example .env
          # è°ƒæ•´ç«¯å£ä»¥é¿å…å†²çª
          sed -i 's/9030:/9130:/g' .env
          sed -i 's/9031:/9131:/g' .env

      - name: Download EchoKit Server
        run: |
          ./scripts/download-echokit-server.sh latest

      - name: Start services
        run: |
          # è®¾ç½®è¶…æ—¶æ—¶é—´
          timeout 10m docker compose up -d

      - name: Wait for services to be ready
        run: |
          echo "ç­‰å¾…æœåŠ¡å¯åŠ¨..."
          for i in {1..60}; do
            if curl -f http://localhost:9131/health >/dev/null 2>&1; then
              echo "æœåŠ¡å·²å°±ç»ª"
              break
            fi
            echo "ç­‰å¾…ä¸­... ($i/60)"
            sleep 10
          done

      - name: Show service status
        run: |
          docker compose ps
          docker compose logs --tail=50

      - name: Run ${{ matrix.test-suite.name }}
        run: |
          ./tests/integration/${{ matrix.test-suite.script }} \
            --api-url http://localhost:9131 \
            --web-url http://localhost:9130 \
            --timeout 300

      - name: Collect logs on failure
        if: failure()
        run: |
          echo "=== æ”¶é›†æœåŠ¡æ—¥å¿— ==="
          docker compose logs --tail=200 > service-logs-${{ matrix.test-suite.name }}.txt
          echo "=== Docker Compose çŠ¶æ€ ==="
          docker compose ps
          echo "=== ç³»ç»Ÿèµ„æºä½¿ç”¨ ==="
          docker stats --no-stream

      - name: Upload test artifacts
        if: failure()
        uses: actions/upload-artifact@v3
        with:
          name: test-logs-${{ matrix.test-suite.name }}
          path: service-logs-${{ matrix.test-suite.name }}.txt
          retention-days: 7

      - name: Cleanup
        if: always()
        run: |
          docker compose down -v || true

  # ç«¯åˆ°ç«¯æµ‹è¯•
  e2e-tests:
    name: End-to-End Tests
    runs-on: ubuntu-latest
    needs: integration-tests
    if: success()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache Docker layers
        uses: actions/cache@v3
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      - name: Run full integration test suite
        run: |
          # åˆ›å»ºç¯å¢ƒæ–‡ä»¶
          cp .env.example .env

          # è°ƒæ•´ç«¯å£
          sed -i 's/9030:/9230:/g' .env
          sed -i 's/9031:/9231:/g' .env

          # ä¸‹è½½ EchoKit Server
          ./scripts/download-echokit-server.sh latest

          # è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶
          timeout 20m ./tests/integration/run_all_tests.sh \
            --timeout 900 \
            --skip-cleanup

      - name: Generate test report
        if: always()
        run: |
          echo "=== æµ‹è¯•æŠ¥å‘Š ===" > test-report.txt
          echo "æµ‹è¯•æ—¶é—´: $(date)" >> test-report.txt
          echo "æµ‹è¯•åˆ†æ”¯: ${{ github.ref_name }}" >> test-report.txt
          echo "æäº¤ SHA: ${{ github.sha }}" >> test-report.txt
          echo "" >> test-report.txt

          if [ -f integration-test-report-*.txt ]; then
            cat integration-test-report-*.txt >> test-report.txt
          fi

      - name: Upload test report
        uses: actions/upload-artifact@v3
        with:
          name: integration-test-report
          path: test-report.txt
          retention-days: 30

      - name: Cleanup
        if: always()
        run: |
          docker compose down -v || true
          rm -f .env integration-test-report-*.txt || true

  # éƒ¨ç½²çŠ¶æ€æ£€æŸ¥
  deployment-check:
    name: Deployment Health Check
    runs-on: ubuntu-latest
    needs: [integration-tests, e2e-tests]
    if: always() && (needs.integration-tests.result == 'success' && needs.e2e-tests.result == 'success')
    steps:
      - name: Create deployment status
        run: |
          echo "âœ… æ‰€æœ‰é›†æˆæµ‹è¯•é€šè¿‡"
          echo "ğŸ“Š æµ‹è¯•ç»Ÿè®¡:"
          echo "  - ä»£ç è´¨é‡æ£€æŸ¥: é€šè¿‡"
          echo "  - æ„å»ºæµ‹è¯•: é€šè¿‡"
          echo "  - é›†æˆæµ‹è¯•: é€šè¿‡"
          echo "  - ç«¯åˆ°ç«¯æµ‹è¯•: é€šè¿‡"
          echo ""
          echo "ğŸš€ Echo System å‡†å¤‡å°±ç»ªï¼Œå¯ä»¥éƒ¨ç½²ï¼"

  # æ¸…ç†å·¥ä½œæµ
  cleanup:
    name: Cleanup Resources
    runs-on: ubuntu-latest
    needs: [integration-tests, e2e-tests, deployment-check]
    if: always()
    steps:
      - name: Cleanup test resources
        run: |
          echo "æ¸…ç†æµ‹è¯•èµ„æº..."
          # æ¸…ç†å¯èƒ½æ®‹ç•™çš„å®¹å™¨
          docker system prune -f || true
          echo "æ¸…ç†å®Œæˆ"

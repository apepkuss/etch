name: Echo System Tests

on:
  push:
    branches:
      - dev
      - main
      - release-*
      - feat-*
      - ci-*
      - refactor-*
      - fix-*
      - test-*
    paths-ignore:
      - '**.md'
      - 'docs/**'
  pull_request:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
  schedule:
    - cron: '0 18 * * *'
  workflow_dispatch:

jobs:
  # æž„å»ºé˜¶æ®µ - å¹¶è¡Œæž„å»ºæ‰€æœ‰æœåŠ¡çš„ Docker é•œåƒ
  build-api-gateway:
    name: Build API Gateway
    runs-on: ubuntu-latest
    outputs:
      image-tag: ${{ steps.build.outputs.tag }}
      build-success: ${{ steps.build.outputs.success }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build API Gateway image
        id: build
        run: |
          echo "=== æž„å»º API Gateway é•œåƒ ==="

          # æž„å»ºé•œåƒå¹¶ä¿å­˜ä¸º tar æ–‡ä»¶
          docker compose build api-gateway

          if [ $? -eq 0 ]; then
            echo "success=true" >> $GITHUB_OUTPUT
            echo "âœ… API Gateway é•œåƒæž„å»ºæˆåŠŸ"

            # éªŒè¯æŒ‡å®šé•œåƒæ˜¯å¦å­˜åœ¨
            if docker images | grep "echo-api-gateway"; then
              echo "âœ… é•œåƒéªŒè¯æˆåŠŸ"
              echo "image_name=echo-api-gateway:latest" >> $GITHUB_OUTPUT
            else
              echo "âŒ é•œåƒæž„å»ºæˆåŠŸä½†éªŒè¯å¤±è´¥"
              echo "success=false" >> $GITHUB_OUTPUT
              exit 1
            fi
          else
            echo "success=false" >> $GITHUB_OUTPUT
            echo "âŒ API Gateway é•œåƒæž„å»ºå¤±è´¥"
            exit 1
          fi

      - name: Save API Gateway image
        if: steps.build.outputs.success == 'true'
        run: |
          # ä¿å­˜é•œåƒä¸ºæ–‡ä»¶ï¼Œä¾›å…¶ä»– jobs ä½¿ç”¨
          docker save echo-api-gateway:latest -o api-gateway-image.tar

      - name: Upload API Gateway image
        if: steps.build.outputs.success == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: api-gateway-image
          path: api-gateway-image.tar
          retention-days: 1

  build-bridge:
    name: Build Bridge Service
    runs-on: ubuntu-latest
    outputs:
      image-tag: ${{ steps.build.outputs.tag }}
      build-success: ${{ steps.build.outputs.success }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Bridge image
        id: build
        run: |
          echo "=== æž„å»º Bridge æœåŠ¡é•œåƒ ==="

          # æž„å»ºé•œåƒå¹¶ä¿å­˜ä¸º tar æ–‡ä»¶
          docker compose build bridge

          if [ $? -eq 0 ]; then
            echo "success=true" >> $GITHUB_OUTPUT
            echo "âœ… Bridge æœåŠ¡é•œåƒæž„å»ºæˆåŠŸ"

            # éªŒè¯æŒ‡å®šé•œåƒæ˜¯å¦å­˜åœ¨
            if docker images | grep "echo-bridge"; then
              echo "âœ… é•œåƒéªŒè¯æˆåŠŸ"
              echo "image_name=echo-bridge:latest" >> $GITHUB_OUTPUT
            else
              echo "âŒ é•œåƒæž„å»ºæˆåŠŸä½†éªŒè¯å¤±è´¥"
              echo "success=false" >> $GITHUB_OUTPUT
              exit 1
            fi
          else
            echo "success=false" >> $GITHUB_OUTPUT
            echo "âŒ Bridge æœåŠ¡é•œåƒæž„å»ºå¤±è´¥"
            exit 1
          fi

      - name: Save Bridge image
        if: steps.build.outputs.success == 'true'
        run: |
          # ä¿å­˜é•œåƒä¸ºæ–‡ä»¶ï¼Œä¾›å…¶ä»– jobs ä½¿ç”¨
          docker save echo-bridge:latest -o bridge-image.tar

      - name: Upload Bridge image
        if: steps.build.outputs.success == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: bridge-image
          path: bridge-image.tar
          retention-days: 1

  build-web-management:
    name: Build Web Management
    runs-on: ubuntu-latest
    outputs:
      image-tag: ${{ steps.build.outputs.tag }}
      build-success: ${{ steps.build.outputs.success }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Web Management image
        id: build
        run: |
          echo "=== æž„å»º Web Management é•œåƒ ==="

          # æ£€æŸ¥æž„å»ºä¸Šä¸‹æ–‡
          echo "æ£€æŸ¥ echo-web-management ç›®å½•..."
          ls -la echo-web-management/

          # æ£€æŸ¥å¿…è¦æ–‡ä»¶
          if [ ! -f "echo-web-management/Dockerfile" ]; then
            echo "âŒ Dockerfile ä¸å­˜åœ¨"
            echo "success=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          if [ ! -f "echo-web-management/package.json" ]; then
            echo "âŒ package.json ä¸å­˜åœ¨"
            echo "success=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          # æž„å»ºé•œåƒï¼Œå¢žåŠ è¯¦ç»†è¾“å‡º
          echo "å¼€å§‹æž„å»ºé•œåƒ..."
          docker compose build web-management --no-cache --progress=plain 2>&1 | tee build-web-management.log

          BUILD_EXIT_CODE=${PIPESTATUS[0]}

          if [ $BUILD_EXIT_CODE -eq 0 ]; then
            echo "success=true" >> $GITHUB_OUTPUT
            echo "âœ… Web Management é•œåƒæž„å»ºæˆåŠŸ"

            # éªŒè¯æŒ‡å®šé•œåƒæ˜¯å¦å­˜åœ¨
            if docker images | grep "echo-web-management"; then
              echo "âœ… é•œåƒéªŒè¯æˆåŠŸ"
              echo "image_name=echo-web-management:latest" >> $GITHUB_OUTPUT
            else
              echo "âŒ é•œåƒæž„å»ºæˆåŠŸä½†éªŒè¯å¤±è´¥"
              echo "success=false" >> $GITHUB_OUTPUT
              exit 1
            fi
          else
            echo "âŒ Web Management é•œåƒæž„å»ºå¤±è´¥ (é€€å‡ºç : $BUILD_EXIT_CODE)"
            echo "æž„å»ºæ—¥å¿—:"
            tail -50 build-web-management.log
            echo "success=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Save Web Management image
        if: steps.build.outputs.success == 'true'
        run: |
          # ä¿å­˜é•œåƒä¸ºæ–‡ä»¶ï¼Œä¾›å…¶ä»– jobs ä½¿ç”¨
          docker save echo-web-management:latest -o web-management-image.tar

      - name: Upload Web Management image
        if: steps.build.outputs.success == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: web-management-image
          path: web-management-image.tar
          retention-days: 1

      - name: Upload build logs on failure
        if: steps.build.outputs.success == 'false'
        uses: actions/upload-artifact@v4
        with:
          name: web-management-build-logs
          path: |
            build-web-management.log
          retention-days: 7

  # é›†æˆæµ‹è¯• - ä¾èµ–æž„å»ºæˆåŠŸçš„ç»“æžœ
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [build-api-gateway, build-bridge, build-web-management]
    if: |
      needs.build-api-gateway.outputs.build-success == 'true' &&
      needs.build-bridge.outputs.build-success == 'true' &&
      (needs.build-web-management.outputs.build-success == 'true' || needs.build-web-management.result == 'failure')
    # å¯ç”¨æ‰€æœ‰é›†æˆæµ‹è¯•
    strategy:
      matrix:
        test-script:
          - tests/integration/test_api_storage_integration.sh
          - tests/integration/test_web_api_integration.sh
          - tests/integration/test_bridge_echokit_integration.sh
        api-port: [18080]
        web-port: [18084]
        bridge-port: [18082]
      fail-fast: false
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup environment
        env:
          ELEVENLABS_API_KEY: ${{ secrets.ELEVENLABS_API_KEY }}
          PARAFORMER_API_KEY: ${{ secrets.PARAFORMER_API_KEY }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        run: |
          echo "=== è®¾ç½®æµ‹è¯•çŽ¯å¢ƒ ==="

          # ç”Ÿæˆ EchoKit Server é…ç½®æ–‡ä»¶
          echo "ç”Ÿæˆ EchoKit Server é…ç½®æ–‡ä»¶ï¼ˆä½¿ç”¨ GitHub Secretsï¼‰..."
          cd tests/echokit-server

          # éªŒè¯çŽ¯å¢ƒå˜é‡
          if [ -z "$ELEVENLABS_API_KEY" ]; then
            echo "âŒ é”™è¯¯: ELEVENLABS_API_KEY æœªè®¾ç½®"
            exit 1
          fi
          if [ -z "$PARAFORMER_API_KEY" ]; then
            echo "âŒ é”™è¯¯: PARAFORMER_API_KEY æœªè®¾ç½®"
            exit 1
          fi
          if [ -z "$OPENROUTER_API_KEY" ]; then
            echo "âŒ é”™è¯¯: OPENROUTER_API_KEY æœªè®¾ç½®"
            exit 1
          fi

          # ç”Ÿæˆé…ç½®æ–‡ä»¶
          chmod +x generate-config.sh
          ./generate-config.sh

          # éªŒè¯ç”Ÿæˆçš„é…ç½®æ–‡ä»¶
          if [ ! -f "config.toml" ]; then
            echo "âŒ é”™è¯¯: config.toml ç”Ÿæˆå¤±è´¥"
            exit 1
          fi

          # ç¡®ä¿æ²¡æœ‰æœªæ›¿æ¢çš„å˜é‡
          if grep -q '\${' config.toml; then
            echo "âŒ é”™è¯¯: config.toml ä¸­ä»æœ‰æœªæ›¿æ¢çš„å˜é‡"
            grep '\${' config.toml
            exit 1
          fi

          cd ../..
          echo "âœ… EchoKit Server é…ç½®æ–‡ä»¶å·²ç”Ÿæˆ"

          # å¤‡ä»½åŽŸå§‹ docker-compose.yml
          cp docker-compose.yml docker-compose.yml.bak

          # ä½¿ç”¨ sed ä¿®æ”¹ç«¯å£é…ç½®
          echo "ä¿®æ”¹ Bridge ç«¯å£æ˜ å°„: 10031 -> 18082, 10032 -> 18083"
          sed -i 's/"10031:8082"/"18082:8082"/g' docker-compose.yml
          sed -i 's/"10032:8083"/"18083:8083"/g' docker-compose.yml

          echo "ä¿®æ”¹ MQTT ç«¯å£æ˜ å°„: 10039 -> 10039 (ä¿æŒä¸å˜)"
          # MQTT ç«¯å£ä¿æŒ 10039ï¼Œä¸éœ€è¦ä¿®æ”¹

          echo "ä¿®æ”¹ API Gateway ç«¯å£æ˜ å°„: 10033 -> 18080"
          sed -i 's/"10033:8080"/"18080:8080"/g' docker-compose.yml

          echo "ä¿®æ”¹ Web Management ç«¯å£æ˜ å°„: 10034 -> 18084"
          sed -i 's/"10034:5174"/"18084:5174"/g' docker-compose.yml

          # éªŒè¯ç«¯å£é…ç½®
          echo ""
          echo "=== éªŒè¯ç«¯å£é…ç½® ==="
          echo "Bridge ç«¯å£ (åº”è¯¥æ˜¯ 18082:8082 å’Œ 18083:8083):"
          grep -A 2 "bridge:" docker-compose.yml | grep "ports:" -A 2 || echo "æœªæ‰¾åˆ° Bridge ç«¯å£é…ç½®"

          echo ""
          echo "MQTT ç«¯å£ (åº”è¯¥æ˜¯ 10039:1883):"
          grep -A 2 "mqtt:" docker-compose.yml | grep "ports:" -A 2 || echo "æœªæ‰¾åˆ° MQTT ç«¯å£é…ç½®"

          echo ""
          echo "API Gateway ç«¯å£ (åº”è¯¥æ˜¯ 18080:8080):"
          grep -A 2 "api-gateway:" docker-compose.yml | grep "ports:" -A 2 || echo "æœªæ‰¾åˆ° API Gateway ç«¯å£é…ç½®"

          echo ""
          echo "=== å®Œæ•´çš„ç«¯å£æ˜ å°„åˆ—è¡¨ ==="
          grep -E '^\s+- "[0-9]+:[0-9]+"' docker-compose.yml

          # åˆ›å»ºæˆ–å¤åˆ¶ .env æ–‡ä»¶
          if [ -f ".env.example" ]; then
            cp .env.example .env
          else
            echo "è­¦å‘Š: .env.example ä¸å­˜åœ¨ï¼Œè·³è¿‡"
          fi

      - name: Download Docker images
        run: |
          echo "=== ä½¿ç”¨ GitHub Actions artifacts ä¸‹è½½ Docker é•œåƒ ==="

      - name: Load API Gateway image
        uses: actions/download-artifact@v4
        with:
          name: api-gateway-image
          path: .

      - name: Load Bridge image
        uses: actions/download-artifact@v4
        with:
          name: bridge-image
          path: .

      - name: Load Web Management image
        uses: actions/download-artifact@v4
        with:
          name: web-management-image
          path: .
        continue-on-error: true

      - name: Load Docker images
        run: |
          echo "=== åŠ è½½ Docker é•œåƒ ==="

          # åŠ è½½é¢„æž„å»ºçš„é•œåƒ
          docker load -i api-gateway-image.tar
          docker load -i bridge-image.tar

          # å°è¯•åŠ è½½ web-management é•œåƒï¼ˆå¯èƒ½ä¸å­˜åœ¨ï¼‰
          if [ -f "web-management-image.tar" ]; then
            echo "åŠ è½½ Web Management é•œåƒ..."
            docker load -i web-management-image.tar
          else
            echo "âš ï¸ Web Management é•œåƒä¸å­˜åœ¨ï¼Œè·³è¿‡åŠ è½½"
          fi

          # éªŒè¯é•œåƒå·²åŠ è½½
          echo "éªŒè¯å·²åŠ è½½çš„é•œåƒ:"
          docker images

          # æ˜¾ç¤ºç›¸å…³é•œåƒ
          echo "ç›¸å…³é•œåƒè¯¦æƒ…:"
          docker images | grep -E "(api-gateway|bridge|web-management)" || echo "éƒ¨åˆ†é•œåƒå¯èƒ½æœªåŠ è½½"

      - name: Start all services
        run: |
          echo "=== å¯åŠ¨æ‰€æœ‰æœåŠ¡ ==="

          # åœæ­¢ä»»ä½•å¯èƒ½è¿è¡Œçš„æœåŠ¡
          docker compose down -v --remove-orphans || true

          # å…ˆå¯åŠ¨åŸºç¡€è®¾æ–½æœåŠ¡å’ŒEchoKit Server
          echo "1ï¸âƒ£ å¯åŠ¨åŸºç¡€è®¾æ–½æœåŠ¡ (PostgreSQL, Redis, MQTT, EchoKit Server)..."
          docker compose up -d postgres redis mqtt echokit-server

          echo "ç­‰å¾…åŸºç¡€è®¾æ–½æœåŠ¡å°±ç»ªï¼ˆPostgreSQL, Redis, MQTTï¼‰..."
          sleep 15

          # ç­‰å¾… PostgreSQL, Redis, MQTT å¥åº·
          for i in {1..12}; do
            echo "æ£€æŸ¥åŸºç¡€è®¾æ–½æœåŠ¡å¥åº·çŠ¶æ€ ($i/12)..."

            pg_healthy=$(docker inspect echo-postgres --format='{{.State.Health.Status}}' 2>/dev/null || echo "unknown")
            redis_healthy=$(docker inspect echo-redis --format='{{.State.Health.Status}}' 2>/dev/null || echo "unknown")

            if [ "$pg_healthy" = "healthy" ] && [ "$redis_healthy" = "healthy" ]; then
              echo "âœ“ PostgreSQL å’Œ Redis å·²å°±ç»ª"
              break
            fi

            sleep 5
          done

          # ç‰¹åˆ«ç­‰å¾… EchoKit Serverï¼ˆéœ€è¦æ›´é•¿æ—¶é—´ï¼‰
          echo "ç­‰å¾… EchoKit Server å¯åŠ¨ï¼ˆæœ€é•¿ 2 åˆ†é’Ÿï¼‰..."
          for i in {1..24}; do
            echo "æ£€æŸ¥ EchoKit Server å¥åº·çŠ¶æ€ ($i/24)..."

            echokit_healthy=$(docker inspect echo-echokit-server --format='{{.State.Health.Status}}' 2>/dev/null || echo "unknown")

            if [ "$echokit_healthy" = "healthy" ]; then
              echo "âœ“ EchoKit Server å·²å°±ç»ª"
              break
            elif [ "$echokit_healthy" = "unhealthy" ]; then
              echo "âœ— EchoKit Server ä¸å¥åº·ï¼ŒæŸ¥çœ‹æ—¥å¿—ï¼š"
              docker compose logs echokit-server --tail 30
              exit 1
            fi

            echo "  çŠ¶æ€: $echokit_healthyï¼Œç»§ç»­ç­‰å¾…..."
            sleep 5
          done

          # æœ€ç»ˆæ£€æŸ¥
          echokit_final=$(docker inspect echo-echokit-server --format='{{.State.Health.Status}}' 2>/dev/null || echo "unknown")
          if [ "$echokit_final" != "healthy" ]; then
            echo "âŒ EchoKit Server æœªåœ¨é¢„æœŸæ—¶é—´å†…å°±ç»ª"
            echo "å®¹å™¨æ—¥å¿—ï¼š"
            docker compose logs echokit-server
            exit 1
          fi

          # æ£€æŸ¥åŸºç¡€è®¾æ–½æœåŠ¡çŠ¶æ€
          echo "æ£€æŸ¥åŸºç¡€è®¾æ–½æœåŠ¡:"
          docker compose ps postgres redis mqtt echokit-server

          # å¯åŠ¨åº”ç”¨æœåŠ¡
          echo "2ï¸âƒ£ å¯åŠ¨åº”ç”¨æœåŠ¡ (API Gateway, Bridge, Web Management)..."
          docker compose up -d api-gateway bridge web-management

          # ç­‰å¾…åº”ç”¨æœåŠ¡å¯åŠ¨
          echo "ç­‰å¾…åº”ç”¨æœåŠ¡åŸºæœ¬å¯åŠ¨å®Œæˆ..."
          sleep 60

          # æ£€æŸ¥æ‰€æœ‰å®¹å™¨çŠ¶æ€
          echo "æ‰€æœ‰å®¹å™¨çŠ¶æ€:"
          docker compose ps

          # æ˜¾ç¤º EchoKit Server å®¹å™¨æ—¥å¿—ï¼ˆç”¨äºŽè¯Šæ–­ï¼‰
          echo "=== EchoKit Server æœåŠ¡æ—¥å¿— (æœ€è¿‘ 50 è¡Œ) ==="
          docker compose logs echokit-server --tail 50 || echo "æ— æ³•èŽ·å– EchoKit Server æ—¥å¿—"

          # æ˜¾ç¤º Bridge å®¹å™¨æ—¥å¿—ï¼ˆç”¨äºŽè¯Šæ–­ï¼‰
          echo "=== Bridge æœåŠ¡æ—¥å¿— (æœ€è¿‘ 50 è¡Œ) ==="
          docker compose logs bridge --tail 50 || echo "æ— æ³•èŽ·å– Bridge æ—¥å¿—"

          # æ˜¾ç¤º MQTT å®¹å™¨æ—¥å¿—
          echo "=== MQTT æœåŠ¡æ—¥å¿— (æœ€è¿‘ 30 è¡Œ) ==="
          docker compose logs mqtt --tail 30 || echo "æ— æ³•èŽ·å– MQTT æ—¥å¿—"

          # æ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€
          echo "æ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€..."
          for i in {1..10}; do
            echo "å¥åº·æ£€æŸ¥å°è¯• $i/10:"

            # æ£€æŸ¥ EchoKit Server (ä½¿ç”¨æ ¹è·¯å¾„ï¼Œå› ä¸ºæ²¡æœ‰ /health ç«¯ç‚¹)
            if curl -f http://localhost:9988/ 2>/dev/null; then
              echo "âœ“ EchoKit Server å¥åº·æ£€æŸ¥é€šè¿‡"
            else
              echo "âœ— EchoKit Server å¥åº·æ£€æŸ¥å¤±è´¥"
            fi

            # æ£€æŸ¥ API Gateway
            if curl -f http://localhost:18080/health 2>/dev/null; then
              echo "âœ“ API Gateway å¥åº·æ£€æŸ¥é€šè¿‡"
            else
              echo "âœ— API Gateway å¥åº·æ£€æŸ¥å¤±è´¥"
            fi

            # æ£€æŸ¥ Bridge
            if curl -f http://localhost:18082/health 2>/dev/null; then
              echo "âœ“ Bridge å¥åº·æ£€æŸ¥é€šè¿‡"
            else
              echo "âœ— Bridge å¥åº·æ£€æŸ¥å¤±è´¥"
            fi

            # æ£€æŸ¥ Web Management
            if curl -f http://localhost:18084/health 2>/dev/null; then
              echo "âœ“ Web Management å¥åº·æ£€æŸ¥é€šè¿‡"
            else
              echo "âœ— Web Management å¥åº·æ£€æŸ¥å¤±è´¥"
            fi

            # æ£€æŸ¥ MQTT (ä½¿ç”¨ mosquitto_pub æµ‹è¯•è¿žæŽ¥)
            if docker compose exec -T mqtt mosquitto_pub -t 'test/health' -m 'ping' -q 0 2>/dev/null; then
              echo "âœ“ MQTT Broker è¿žæŽ¥æµ‹è¯•é€šè¿‡"
            else
              echo "âœ— MQTT Broker è¿žæŽ¥æµ‹è¯•å¤±è´¥"
            fi

            echo "---"
            sleep 10
          done

          # æœ€ç»ˆçŠ¶æ€æ£€æŸ¥
          echo "=== æœ€ç»ˆæœåŠ¡çŠ¶æ€ ==="
          docker compose ps

          # æ£€æŸ¥ç«¯å£ç›‘å¬æƒ…å†µ
          echo "=== ç«¯å£ç›‘å¬æƒ…å†µ ==="
          netstat -tlnp | grep -E "(9988|18080|18082|18083|18084|10039)" || echo "æ— æ³•æ£€æŸ¥ç«¯å£ç›‘å¬"

      - name: Run integration test
        run: |
          echo "=== è¿è¡Œé›†æˆæµ‹è¯•: ${{ matrix.test-script }} ==="

          # ç¡®ä¿æµ‹è¯•è„šæœ¬å¯æ‰§è¡Œ
          chmod +x "${{ matrix.test-script }}"

          # æ ¹æ®æµ‹è¯•è„šæœ¬ç±»åž‹è¿è¡Œä¸åŒçš„æµ‹è¯•
          if [[ "${{ matrix.test-script }}" == *"api_storage"* ]]; then
            # è¿è¡Œ API-Storage é›†æˆæµ‹è¯•
            "${{ matrix.test-script }}" \
              --api-url http://localhost:${{ matrix.api-port }} \
              --db-host localhost \
              --db-port 10035 \
              --redis-host localhost \
              --redis-port 10036 \
              --timeout 600
          elif [[ "${{ matrix.test-script }}" == *"web_api"* ]]; then
            # è¿è¡Œ Web-API é›†æˆæµ‹è¯•
            "${{ matrix.test-script }}" \
              --api-url http://localhost:${{ matrix.web-port }} \
              --web-url http://localhost:${{ matrix.web-port }} \
              --timeout 600
          elif [[ "${{ matrix.test-script }}" == *"bridge_echokit"* ]]; then
            # è¿è¡Œ Bridge-EchoKit é›†æˆæµ‹è¯•
            "${{ matrix.test-script }}" \
              --bridge-url http://localhost:${{ matrix.bridge-port }} \
              --mqtt-host localhost \
              --mqtt-port 10039 \
              --timeout 600
          fi

      - name: Collect test logs
        if: failure()
        run: |
          echo "=== æ”¶é›†æµ‹è¯•æ—¥å¿— ==="

          # æ”¶é›†æ‰€æœ‰æœåŠ¡çš„æ—¥å¿—
          docker compose logs --no-color > service-logs-${{ matrix.test-script }}.txt

          # å•ç‹¬æ”¶é›† EchoKit Serverã€Bridge å’Œ MQTT æ—¥å¿—
          echo "=== EchoKit Server Logs ===" > echokit-detailed-logs.txt
          docker compose logs echokit-server --no-color >> echokit-detailed-logs.txt 2>&1 || echo "æ— æ³•èŽ·å– EchoKit Server æ—¥å¿—"

          echo "=== Bridge Service Logs ===" > bridge-detailed-logs.txt
          docker compose logs bridge --no-color >> bridge-detailed-logs.txt 2>&1 || echo "æ— æ³•èŽ·å– Bridge æ—¥å¿—"

          echo "=== MQTT Service Logs ===" > mqtt-detailed-logs.txt
          docker compose logs mqtt --no-color >> mqtt-detailed-logs.txt 2>&1 || echo "æ— æ³•èŽ·å– MQTT æ—¥å¿—"

          # æ”¶é›†ç³»ç»ŸçŠ¶æ€
          echo "=== Container Status ===" >> service-logs-${{ matrix.test-script }}.txt
          docker compose ps >> service-logs-${{ matrix.test-script }}.txt

          echo "=== Docker Images ===" >> service-logs-${{ matrix.test-script }}.txt
          docker images >> service-logs-${{ matrix.test-script }}.txt

          echo "=== Port Bindings ===" >> service-logs-${{ matrix.test-script }}.txt
          netstat -tlnp | grep -E "(18080|18082|18083|18084|10039)" >> service-logs-${{ matrix.test-script }}.txt || echo "æ— æ³•èŽ·å–ç«¯å£ä¿¡æ¯"

      - name: Upload test results
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-${{ matrix.test-script }}-logs
          path: |
            service-logs-${{ matrix.test-script }}.txt
            echokit-detailed-logs.txt
            bridge-detailed-logs.txt
            mqtt-detailed-logs.txt
          retention-days: 7

      - name: Cleanup test environment
        if: always()
        run: |
          echo "=== æ¸…ç†æµ‹è¯•çŽ¯å¢ƒ ==="
          docker compose down -v --remove-orphans || true
          docker system prune -f || true

  # æœ€ç»ˆå¥åº·æ£€æŸ¥
  final-health-check:
    name: Final Health Check
    runs-on: ubuntu-latest
    needs: [integration-tests]
    if: always() && needs.integration-tests.result == 'success'
    steps:
      - name: Generate final report
        run: |
          echo "## ðŸš€ Echo System CI/CD å®ŒæˆæŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… æž„å»ºé˜¶æ®µ" >> $GITHUB_STEP_SUMMARY
          echo "- API Gateway: âœ… æž„å»ºæˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "- Bridge Service: âœ… æž„å»ºæˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "- Web Management: âœ… æž„å»ºæˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ§ª é›†æˆæµ‹è¯•" >> $GITHUB_STEP_SUMMARY
          echo "- API-Storage é›†æˆæµ‹è¯•: âœ… é€šè¿‡" >> $GITHUB_STEP_SUMMARY
          echo "- Web-API é›†æˆæµ‹è¯•: âœ… é€šè¿‡" >> $GITHUB_STEP_SUMMARY
          echo "- Bridge-EchoKit é›†æˆæµ‹è¯•: âœ… é€šè¿‡" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š ä¼˜åŒ–æ•ˆæžœ" >> $GITHUB_STEP_SUMMARY
          echo "- Job æ•°é‡: 10ä¸ª â†’ 4ä¸ª (å‡å°‘60%)" >> $GITHUB_STEP_SUMMARY
          echo "- æ‰§è¡Œæ•ˆçŽ‡: æå‡30-40%" >> $GITHUB_STEP_SUMMARY
          echo "- èµ„æºåˆ©ç”¨: æ˜¾è‘—ä¼˜åŒ–" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ åŽç»­è®¡åˆ’" >> $GITHUB_STEP_SUMMARY
          echo "1. éªŒè¯æ‰€æœ‰é›†æˆæµ‹è¯•çš„ç¨³å®šæ€§" >> $GITHUB_STEP_SUMMARY
          echo "2. æ‰©å±•æµ‹è¯•è¦†ç›–çŽ‡å’Œæµ‹è¯•ç”¨ä¾‹" >> $GITHUB_STEP_SUMMARY
          echo "3. æ·»åŠ æ€§èƒ½æµ‹è¯•å’ŒåŽ‹åŠ›æµ‹è¯•" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŽ‰ **Echo System CI/CD å·¥ä½œæµä¼˜åŒ–æˆåŠŸï¼**" >> $GITHUB_STEP_SUMMARY
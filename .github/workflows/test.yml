name: Echo System Tests

on:
  push:
    branches: [ main, dev ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
  pull_request:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
  schedule:
    # æ¯å¤©å‡Œæ™¨ 2 ç‚¹è¿è¡Œ
    - cron: '0 2 * * *'
  workflow_dispatch:

# env:
#   DOCKER_BUILDKIT: 1
#   COMPOSE_DOCKER_CLI_BUILD: 1

jobs:
  # EchoKit Server ç‹¬ç«‹éƒ¨ç½²å’Œæµ‹è¯•
  echokit-server-deploy:
    name: EchoKit Server Deployment
    runs-on: ubuntu-latest
    outputs:
      echokit-ready: ${{ steps.test.outputs.success }}
      echokit-logs: ${{ steps.logs.outputs.content }}
      echokit-startup-time: ${{ steps.timing.outputs.duration }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup environment
        run: |
          cp .env.example .env
          echo "=== ç¯å¢ƒé…ç½® ==="
          cat .env | grep -E "(ECHOKIT|PORT)"

          # åˆ›å»ºå¿…è¦çš„ç›®å½•
          mkdir -p echokit_recordings logs

      - name: Pull EchoKit Server image
        run: |
          echo "=== æ‹‰å– Docker Hub é•œåƒ ==="
          docker pull secondstate/echokit:latest-server-vad
          docker images | grep echokit

      - name: Verify EchoKit Server configuration
        run: |
          echo "=== éªŒè¯é…ç½®æ–‡ä»¶ ==="
          ls -la tests/echokit-server/
          echo "--- config.toml ---"
          cat tests/echokit-server/config.toml
          echo "--- docker-compose.echokit.yml ---"
          cat tests/echokit-server/docker-compose.echokit.yml
          echo "--- test-echokit.sh ---"
          cat tests/echokit-server/test-echokit.sh

      - name: Deploy EchoKit Server
        id: timing
        run: |
          echo "=== å¼€å§‹éƒ¨ç½² EchoKit Server ==="
          START_TIME=$(date +%s)

          # ä½¿ç”¨ç°æœ‰çš„æµ‹è¯•é…ç½®æ–‡ä»¶
          cd tests/echokit-server
          docker-compose -f docker-compose.echokit.yml up -d

          echo "=== ç­‰å¾…æœåŠ¡å¯åŠ¨ ==="

          # ç­‰å¾…å¥åº·æ£€æŸ¥é€šè¿‡æˆ–è¶…æ—¶
          MAX_WAIT=120  # æœ€å¤šç­‰å¾…2åˆ†é’Ÿ
          WAIT_TIME=0

          while [ $WAIT_TIME -lt $MAX_WAIT ]; do
            if curl -f http://localhost:10030/health 2>/dev/null; then
              echo "âœ… æœåŠ¡å¯åŠ¨æˆåŠŸï¼"
              break
            fi
            echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨... (${WAIT_TIME}s/${MAX_WAIT}s)"
            sleep 5
            WAIT_TIME=$((WAIT_TIME + 5))
          done

          if [ $WAIT_TIME -ge $MAX_WAIT ]; then
            echo "âŒ æœåŠ¡å¯åŠ¨è¶…æ—¶"
            docker-compose -f docker-compose.echokit.yml logs echokit-server
            exit 1
          fi

          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "duration=$DURATION" >> $GITHUB_OUTPUT
          echo "ğŸš€ å¯åŠ¨è€—æ—¶: ${DURATION}ç§’"

      - name: Run comprehensive tests
        id: test
        run: |
          echo "=== è¿è¡Œç»¼åˆæµ‹è¯• ==="

          # ä½¿ç”¨æµ‹è¯•è„šæœ¬
          cd tests/echokit-server

          if bash test-echokit.sh; then
            echo "âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡"
            echo "success=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ æµ‹è¯•å¤±è´¥"
            echo "success=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          # é¢å¤–çš„è¯¦ç»†æµ‹è¯•
          echo "=== è¯¦ç»† API æµ‹è¯• ==="

          # æµ‹è¯•æ¨¡å‹åˆ—è¡¨
          echo "1. æ¨¡å‹åˆ—è¡¨æµ‹è¯•:"
          MODELS_RESPONSE=$(curl -s http://localhost:10030/v1/models)
          if echo "$MODELS_RESPONSE" | jq -e '.data | length > 0'; then
            echo "âœ… æ¨¡å‹åˆ—è¡¨æ­£å¸¸"
          else
            echo "âŒ æ¨¡å‹åˆ—è¡¨ä¸ºç©ºæˆ–æ ¼å¼é”™è¯¯"
          fi

          # æµ‹è¯•å®¹å™¨çŠ¶æ€
          echo "2. å®¹å™¨çŠ¶æ€æ£€æŸ¥:"
          if docker ps | grep test-echokit-server; then
            echo "âœ… å®¹å™¨è¿è¡Œæ­£å¸¸"
          else
            echo "âŒ å®¹å™¨æœªè¿è¡Œ"
          fi

          # æµ‹è¯•èµ„æºä½¿ç”¨
          echo "3. èµ„æºä½¿ç”¨æ£€æŸ¥:"
          MEMORY_USAGE=$(docker stats --no-stream test-echokit-server --format "{{.MemPerc}}")
          CPU_USAGE=$(docker stats --no-stream test-echokit-server --format "{{.CPUPerc}}")
          echo "ğŸ“Š å†…å­˜ä½¿ç”¨: $MEMORY_USAGE"
          echo "ğŸ“Š CPUä½¿ç”¨: $CPU_USAGE"

      - name: Collect comprehensive logs
        id: logs
        if: always()
        run: |
          echo "=== æ”¶é›†è¯¦ç»†çš„éƒ¨ç½²æ—¥å¿— ==="

          cd tests/echokit-server

          # å®¹å™¨çŠ¶æ€
          echo "=== ğŸ“‹ å®¹å™¨çŠ¶æ€ ==="
          docker-compose -f docker-compose.echokit.yml ps
          echo ""

          # æœåŠ¡æ—¥å¿—ï¼ˆæŒ‰æ—¶é—´æ’åºï¼Œæœ€æ–°çš„åœ¨å‰ï¼‰
          echo "=== ğŸ“‹ æœåŠ¡æ—¥å¿— (æœ€æ–°200è¡Œ) ==="
          docker-compose -f docker-compose.echokit.yml logs --tail=200 --timestamps echokit-server
          echo ""

          # å¥åº·æ£€æŸ¥å†å²
          echo "=== ğŸ“‹ å¥åº·æ£€æŸ¥å†å² ==="
          docker inspect test-echokit-server | jq -r '.[0].State.Health.Log[] | "\(.End) \(.ExitCode) \(.Output)"' | tail -10
          echo ""

          # ç½‘ç»œä¿¡æ¯
          echo "=== ğŸ“‹ ç½‘ç»œä¿¡æ¯ ==="
          docker network ls | grep echokit
          docker network inspect echokit-test-network | jq '.[0].Containers | keys | length' | xargs echo "è¿æ¥çš„å®¹å™¨æ•°é‡:"
          echo ""

          # æŒ‚è½½ç‚¹æ£€æŸ¥
          echo "=== ğŸ“‹ æŒ‚è½½ç‚¹æ£€æŸ¥ ==="
          docker inspect test-echokit-server | jq '.[0].Mounts[] | {Source, Destination, RW}' || echo "æ— æ³•è·å–æŒ‚è½½ä¿¡æ¯"
          echo ""

          # ç¯å¢ƒå˜é‡ï¼ˆä¸åŒ…å«æ•æ„Ÿä¿¡æ¯ï¼‰
          echo "=== ğŸ“‹ ç¯å¢ƒå˜é‡ ==="
          docker inspect test-echokit-server | jq '.[0].Config.Env[] | select(contains("PASSWORD") | not)' | head -10
          echo ""

          # ç«¯å£çŠ¶æ€
          echo "=== ğŸ“‹ ç«¯å£çŠ¶æ€ ==="
          netstat -tulpn | grep 10030 || echo "ç«¯å£ 10030 æœªç›‘å¬"
          echo ""

          # ç³»ç»Ÿèµ„æº
          echo "=== ğŸ“‹ ç³»ç»Ÿèµ„æºä½¿ç”¨ ==="
          docker stats --no-stream --format "table {{.Container}}\t{{.CPUPerc}}\t{{.MemUsage}}\t{{.NetIO}}\t{{.BlockIO}}" test-echokit-server

          # ä¿å­˜è¯¦ç»†æ—¥å¿—åˆ°è¾“å‡º
          echo "content<<EOF" >> $GITHUB_OUTPUT
          echo "=== EchoKit Server éƒ¨ç½²æ—¥å¿— ==="
          echo "éƒ¨ç½²æ—¶é—´: $(date)"
          echo "å¯åŠ¨è€—æ—¶: ${{ steps.timing.outputs.duration }}ç§’"
          echo ""
          echo "=== æœåŠ¡æ—¥å¿— ==="
          docker-compose -f docker-compose.echokit.yml logs --tail=200 echokit-server >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Performance benchmarks
        if: steps.test.outputs.success == 'true'
        run: |
          echo "=== æ€§èƒ½åŸºå‡†æµ‹è¯• ==="

          # API å“åº”æ—¶é—´æµ‹è¯•
          echo "1. API å“åº”æ—¶é—´æµ‹è¯•:"
          for i in {1..5}; do
            RESPONSE_TIME=$(curl -o /dev/null -s -w '%{time_total}' http://localhost:10030/health)
            echo "   è¯·æ±‚ $i: ${RESPONSE_TIME}s"
          done

          # å¹¶å‘è¿æ¥æµ‹è¯•ï¼ˆç®€å•ï¼‰
          echo "2. å¹¶å‘è¿æ¥æµ‹è¯•:"
          for i in {1..3}; do
            (curl -f http://localhost:10030/health &) &
          done
          wait
          echo "   3ä¸ªå¹¶å‘è¯·æ±‚å®Œæˆ"

          # VAD æ€§èƒ½æµ‹è¯•ï¼ˆå¦‚æœå¯ç”¨ï¼‰
          echo "3. VAD æ€§èƒ½æµ‹è¯•:"
          if curl -f http://localhost:10030/vad/health 2>/dev/null; then
            echo "   VAD æœåŠ¡å“åº”æ­£å¸¸"
          else
            echo "   VAD æœåŠ¡æœªå¯ç”¨æˆ–ä¸å¯ç”¨"
          fi

      - name: Cleanup EchoKit Server
        if: always()
        run: |
          echo "=== æ¸…ç† EchoKit Server ==="
          cd tests/echokit-server

          # ä¿å­˜æ—¥å¿—åˆ°æ–‡ä»¶
          docker-compose -f docker-compose.echokit.yml logs echokit-server > echokit-server-$(date +%Y%m%d-%H%M%S).log

          # åœæ­¢å¹¶æ¸…ç†
          docker-compose -f docker-compose.echokit.yml down -v --remove-orphans || true

          # æ¸…ç†é•œåƒï¼ˆå¯é€‰ï¼‰
          docker rmi secondstate/echokit:latest-server-vad || true

          # æ¸…ç†æµ‹è¯•ç›®å½•
          cd ../../
          rm -rf echokit_recordings logs || true

      - name: Upload EchoKit Server logs and artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: echokit-server-logs-${{ github.run_number }}
          path: |
            tests/echokit-server/docker-compose.echokit.yml
            tests/echokit-server/config.toml
            tests/echokit-server/test-echokit.sh
            tests/echokit-server/*.log
          retention-days: 14
          if-no-files-found: warn

      - name: Generate deployment report
        if: always()
        run: |
          echo "## ğŸš€ EchoKit Server éƒ¨ç½²æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| é¡¹ç›® | å€¼ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|----|" >> $GITHUB_STEP_SUMMARY
          echo "| é•œåƒç‰ˆæœ¬ | secondstate/echokit:latest-server-vad |" >> $GITHUB_STEP_SUMMARY
          echo "| å¯åŠ¨è€—æ—¶ | ${{ steps.timing.outputs.duration }}ç§’ |" >> $GITHUB_STEP_SUMMARY
          echo "| éƒ¨ç½²çŠ¶æ€ | ${{ steps.test.outputs.success == 'true' && 'âœ… æˆåŠŸ' || 'âŒ å¤±è´¥' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ç«¯å£æ˜ å°„ | 10030:8080 |" >> $GITHUB_STEP_SUMMARY
          echo "| VAD æœåŠ¡ | ${{ contains(steps.logs.outputs.content, 'VAD') && 'âœ… å¯ç”¨' || 'âŒ æœªå¯ç”¨' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.test.outputs.success }}" == "true" ]; then
            echo "### âœ… æµ‹è¯•é€šè¿‡é¡¹ç›®" >> $GITHUB_STEP_SUMMARY
            echo "- [x] å®¹å™¨å¯åŠ¨" >> $GITHUB_STEP_SUMMARY
            echo "- [x] å¥åº·æ£€æŸ¥" >> $GITHUB_STEP_SUMMARY
            echo "- [x] API åŠŸèƒ½" >> $GITHUB_STEP_SUMMARY
            echo "- [x] é…ç½®éªŒè¯" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ å¤±è´¥åŸå› åˆ†æ" >> $GITHUB_STEP_SUMMARY
            echo "è¯·æ£€æŸ¥ä¸Šä¼ çš„æ—¥å¿—æ–‡ä»¶è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯ã€‚" >> $GITHUB_STEP_SUMMARY
          fi

  # # åŸºç¡€ä»£ç æ£€æŸ¥
  # code-quality:
  #   name: Code Quality Checks
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4

  #     - name: Setup Rust
  #       uses: actions-rs/toolchain@v1
  #       with:
  #         toolchain: stable
  #         components: rustfmt, clippy

  #     - name: Setup Node.js
  #       uses: actions/setup-node@v4
  #       with:
  #         node-version: '18'
  #         cache: 'npm'
  #         cache-dependency-path: 'echo-web-management/package-lock.json'

  #     - name: Rust format check
  #       run: |
  #         cargo fmt --all -- --check

  #     - name: Rust clippy check
  #       run: |
  #         cargo clippy --all-targets --all-features -- -D warnings

  #     - name: Node.js dependencies check
  #       working-directory: ./echo-web-management
  #       run: |
  #         npm ci
  #         npm run lint
  #         npm run build

  # æ„å»ºæµ‹è¯•
  build:
    name: Build Services
    runs-on: ubuntu-latest
    needs: echokit-server-deploy
    if: needs.echokit-server-deploy.outputs.echokit-ready == 'true'
    outputs:
      images-built: ${{ steps.build.outputs.success }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build Docker images
        id: build
        run: |
          # åˆ›å»ºç¯å¢ƒæ–‡ä»¶
          cp .env.example .env

          # åˆ›å»ºå…±äº«åº“ä¸´æ—¶å‰¯æœ¬
          echo "=== åˆ›å»ºå…±äº«åº“ä¸´æ—¶å‰¯æœ¬ ==="
          cp -r shared bridge/shared_temp || echo "âŒ åˆ›å»º bridge/shared_temp å¤±è´¥"
          cp -r shared api-gateway/shared_temp || echo "âŒ åˆ›å»º api-gateway/shared_temp å¤±è´¥"

          # éªŒè¯æ„å»ºä¸Šä¸‹æ–‡æ–‡ä»¶å­˜åœ¨
          echo "=== éªŒè¯æ„å»ºä¸Šä¸‹æ–‡ ==="
          ls -la api-gateway/src/ || echo "âŒ api-gateway/src ä¸å­˜åœ¨"
          ls -la bridge/src/ || echo "âŒ bridge/src ä¸å­˜åœ¨"
          ls -la shared/ || echo "âŒ shared ä¸å­˜åœ¨"
          ls -la bridge/shared_temp/ || echo "âŒ bridge/shared_temp ä¸å­˜åœ¨"
          ls -la api-gateway/shared_temp/ || echo "âŒ api-gateway/shared_temp ä¸å­˜åœ¨"

          # æ¸…ç† Docker ç¼“å­˜
          echo "=== æ¸…ç† Docker ç¼“å­˜ ==="
          docker system prune -f

          # æ„å»ºå…¶ä»–æœåŠ¡é•œåƒï¼ˆæ’é™¤ EchoKit Serverï¼‰
          echo "=== å¼€å§‹æ„å»º Docker é•œåƒï¼ˆæ’é™¤ EchoKit Serverï¼‰==="
          docker compose build --no-cache bridge api-gateway web-management postgres redis pgadmin redis-commander mqtt
          echo "success=true" >> $GITHUB_OUTPUT

          echo "âœ… æ„å»ºå®Œæˆï¼ŒEchoKit Server å°†ä½¿ç”¨ Docker Hub é•œåƒ"

  # é›†æˆæµ‹è¯•
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [echokit-server-deploy, build]
    if: needs.echokit-server-deploy.outputs.echokit-ready == 'true' && needs.build.outputs.images-built == 'true'
    strategy:
      matrix:
        test-suite: [
          { name: "Web-API Integration", script: "test_web_api_integration.sh" },
          { name: "API-Storage Integration", script: "test_api_storage_integration.sh" }
        ]
    services:
      # é¢„å¯åŠ¨æ•°æ®åº“æœåŠ¡ç”¨äºæµ‹è¯•
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_PASSWORD: test_password
          POSTGRES_USER: test_user
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5433:5432

      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6380:6379

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Note: Removed Docker Buildx and cache to resolve build context issues
      # Using traditional Docker engine for better compatibility

      - name: Create environment file
        run: |
          cp .env.example .env
          # è°ƒæ•´ç«¯å£ä»¥é¿å…å†²çª
          sed -i 's/9030:/9130:/g' .env
          sed -i 's/9031:/9131:/g' .env
          sed -i 's/10030:/9129:/g' .env
          # è°ƒæ•´æ•°æ®åº“ç«¯å£ä»¥é¿å…ä¸æœ¬åœ°è¿›ç¨‹å†²çª
          sed -i 's/5432:5432/5433:5432/g' .env
          sed -i 's/6379:6379/6380:6379/g' .env

      - name: Pull EchoKit Server image
        run: |
          echo "=== æ‹‰å– EchoKit Server é•œåƒ ==="
          docker pull secondstate/echokit:latest-server-vad

      - name: Start services
        run: |
          # æ¸…ç†å¯èƒ½å­˜åœ¨çš„å®¹å™¨å’Œç«¯å£å ç”¨
          echo "=== æ¸…ç†ç°æœ‰å®¹å™¨ ==="
          docker compose down -v --remove-orphans || true
          docker system prune -f || true

          # ç­‰å¾…ç«¯å£é‡Šæ”¾
          echo "=== ç­‰å¾…ç«¯å£é‡Šæ”¾ ==="
          sleep 10

          # è®¾ç½®è¶…æ—¶æ—¶é—´å¹¶å¯åŠ¨æœåŠ¡ï¼ˆä½¿ç”¨ Docker Hub é•œåƒçš„ EchoKit Serverï¼‰
          echo "=== å¯åŠ¨æœåŠ¡ï¼ˆEchoKit Server ä½¿ç”¨ Docker Hub é•œåƒï¼‰==="

          # åˆ›å»ºä¸´æ—¶çš„ echokit-server æœåŠ¡é…ç½®
          cat > docker-compose.echokit-test.yml << 'EOF'
version: '3.8'
services:
  echokit-server:
    image: secondstate/echokit:latest-server-vad
    container_name: test-echokit-server
    environment:
      RUST_LOG: info
    volumes:
      - ./tests/echokit-server/config.toml:/app/config.toml:ro
      - ./tests/echokit-server/hello.wav:/app/hello.wav:ro
      - ./echokit_recordings:/app/record
    ports:
      - "9129:8080"
    networks:
      - echo-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
EOF

          # å¯åŠ¨é™¤ echokit-server ä¹‹å¤–çš„æœåŠ¡
          timeout 10m docker compose up -d postgres redis bridge api-gateway web-management

          # å¯åŠ¨ EchoKit Serverï¼ˆä½¿ç”¨ Docker Hub é•œåƒï¼‰
          docker-compose -f docker-compose.echokit-test.yml up -d echokit-server

      - name: Debug services on failure
        if: failure()
        run: |
          echo "=== æœåŠ¡å¯åŠ¨å¤±è´¥ï¼Œæ”¶é›†è°ƒè¯•ä¿¡æ¯ ==="
          echo "=== Docker Compose çŠ¶æ€ ==="
          docker compose ps
          echo ""
          echo "=== å®¹å™¨æ—¥å¿— ==="
          docker compose logs --tail=100
          echo ""
          echo "=== ç³»ç»Ÿèµ„æºä½¿ç”¨ ==="
          docker stats --no-stream
          echo ""
          echo "=== ç½‘ç»œçŠ¶æ€ ==="
          docker network ls
          echo ""
          echo "=== ç«¯å£å ç”¨æƒ…å†µ ==="
          netstat -tulpn | grep -E "(5433|6380|8080|8082|8083|9129)" || echo "æœªæ£€æµ‹åˆ°ç›¸å…³ç«¯å£å ç”¨"
          echo ""
          echo "=== Docker ç³»ç»Ÿä¿¡æ¯ ==="
          docker system df
          echo ""
          echo "=== ç£ç›˜ç©ºé—´æ£€æŸ¥ ==="
          df -h

      - name: Wait for services to be ready
        run: |
          echo "ç­‰å¾…æœåŠ¡å¯åŠ¨..."

          # ç­‰å¾… API Gateway
          for i in {1..60}; do
            if curl -f http://localhost:9131/health >/dev/null 2>&1; then
              echo "âœ… API Gateway å·²å°±ç»ª"
              break
            fi
            echo "â³ ç­‰å¾… API Gateway... ($i/60)"
            sleep 10
          done

          # æ£€æŸ¥ EchoKit Server
          if curl -f http://localhost:9129/health >/dev/null 2>&1; then
            echo "âœ… EchoKit Server å·²å°±ç»ª"
          else
            echo "âŒ EchoKit Server æœªå°±ç»ª"
            docker-compose -f docker-compose.echokit-test.yml logs echokit-server --tail=50
            exit 1
          fi

      - name: Show service status
        run: |
          docker compose ps
          docker compose logs --tail=50

      - name: Run ${{ matrix.test-suite.name }}
        run: |
          ./tests/integration/${{ matrix.test-suite.script }} \
            --api-url http://localhost:9131 \
            --web-url http://localhost:9130 \
            --timeout 300

      - name: Collect logs on failure
        if: failure()
        run: |
          echo "=== æ”¶é›†æœåŠ¡æ—¥å¿— ==="
          docker compose logs --tail=200 > service-logs-${{ matrix.test-suite.name }}.txt
          echo "=== Docker Compose çŠ¶æ€ ==="
          docker compose ps
          echo "=== ç³»ç»Ÿèµ„æºä½¿ç”¨ ==="
          docker stats --no-stream

      - name: Upload test artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-logs-${{ matrix.test-suite.name }}
          path: service-logs-${{ matrix.test-suite.name }}.txt
          retention-days: 7

      - name: Cleanup
        if: always()
        run: |
          echo "=== æ¸…ç†æµ‹è¯•èµ„æº ==="
          docker compose down -v --remove-orphans || true
          docker-compose -f docker-compose.echokit-test.yml down -v --remove-orphans || true
          docker system prune -f || true
          rm -f docker-compose.echokit-test.yml || true
          echo "=== æ¸…ç†å®Œæˆ ==="

  # ç«¯åˆ°ç«¯æµ‹è¯•
  e2e-tests:
    name: End-to-End Tests
    runs-on: ubuntu-latest
    needs: [echokit-server-deploy, build, integration-tests]
    if: needs.echokit-server-deploy.outputs.echokit-ready == 'true' && needs.integration-tests.result == 'success'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Note: Removed Docker Buildx and cache to resolve build context issues
      # Using traditional Docker engine for better compatibility

      - name: Run full integration test suite
        run: |
          # åˆ›å»ºç¯å¢ƒæ–‡ä»¶
          cp .env.example .env

          # è°ƒæ•´ç«¯å£
          sed -i 's/9030:/9230:/g' .env
          sed -i 's/9031:/9231:/g' .env
          # è°ƒæ•´æ•°æ®åº“ç«¯å£ä»¥é¿å…ä¸æœ¬åœ°è¿›ç¨‹å†²çª
          sed -i 's/5432:5432/5434:5432/g' .env
          sed -i 's/6379:6379/6381:6379/g' .env
          sed -i 's/10030:/9230:/g' .env

          # æ¸…ç†å¯èƒ½å­˜åœ¨çš„å®¹å™¨å’Œç«¯å£å ç”¨
          echo "=== æ¸…ç†ç°æœ‰å®¹å™¨ ==="
          docker compose down -v --remove-orphans || true
          docker system prune -f || true

          # ç­‰å¾…ç«¯å£é‡Šæ”¾
          echo "=== ç­‰å¾…ç«¯å£é‡Šæ”¾ ==="
          sleep 10

          # æ‹‰å– EchoKit Server é•œåƒ
          echo "=== æ‹‰å– EchoKit Server é•œåƒ ==="
          docker pull secondstate/echokit:latest-server-vad

          # åˆ›å»º EchoKit Server é…ç½®
          cat > docker-compose.echokit-e2e.yml << 'EOF'
version: '3.8'
services:
  echokit-server:
    image: secondstate/echokit:latest-server-vad
    container_name: e2e-echokit-server
    environment:
      RUST_LOG: info
    volumes:
      - ./tests/echokit-server/config.toml:/app/config.toml:ro
      - ./tests/echokit-server/hello.wav:/app/hello.wav:ro
      - ./echokit_recordings:/app/record
    ports:
      - "9230:8080"
    networks:
      - echo-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
EOF

          # å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆåŒ…æ‹¬ EchoKit Serverï¼‰
          echo "=== å¯åŠ¨å®Œæ•´æœåŠ¡å¥—ä»¶ ==="
          docker compose up -d
          docker-compose -f docker-compose.echokit-e2e.yml up -d echokit-server

          # è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶
          timeout 20m ./tests/integration/run_all_tests.sh \
            --timeout 900 \
            --skip-cleanup

      - name: Debug e2e test services on failure
        if: failure()
        run: |
          echo "=== E2E æµ‹è¯•å¤±è´¥ï¼Œæ”¶é›†è°ƒè¯•ä¿¡æ¯ ==="
          echo "=== Docker Compose çŠ¶æ€ ==="
          docker compose ps
          echo ""
          echo "=== å®¹å™¨æ—¥å¿— ==="
          docker compose logs --tail=100
          echo ""
          echo "=== å¥åº·æ£€æŸ¥çŠ¶æ€ ==="
          docker compose ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
          echo ""
          echo "=== ç¯å¢ƒå˜é‡é…ç½® ==="
          docker compose exec postgres env | grep -E "(POSTGRES|DATABASE)" || echo "æ— æ³•è·å– postgres ç¯å¢ƒå˜é‡"
          docker compose exec redis env | grep -E "(REDIS)" || echo "æ— æ³•è·å– redis ç¯å¢ƒå˜é‡"

      - name: Generate test report
        if: always()
        run: |
          echo "=== æµ‹è¯•æŠ¥å‘Š ===" > test-report.txt
          echo "æµ‹è¯•æ—¶é—´: $(date)" >> test-report.txt
          echo "æµ‹è¯•åˆ†æ”¯: ${{ github.ref_name }}" >> test-report.txt
          echo "æäº¤ SHA: ${{ github.sha }}" >> test-report.txt
          echo "" >> test-report.txt

          if [ -f integration-test-report-*.txt ]; then
            cat integration-test-report-*.txt >> test-report.txt
          fi

      - name: Upload test report
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-report
          path: test-report.txt
          retention-days: 30

      - name: Cleanup
        if: always()
        run: |
          echo "=== æ¸…ç†æµ‹è¯•èµ„æº ==="
          docker compose down -v --remove-orphans || true
          docker-compose -f docker-compose.echokit-e2e.yml down -v --remove-orphans || true
          docker system prune -f || true
          rm -f .env integration-test-report-*.txt docker-compose.echokit-e2e.yml || true
          echo "=== æ¸…ç†å®Œæˆ ==="

  # éƒ¨ç½²çŠ¶æ€æ£€æŸ¥
  deployment-check:
    name: Deployment Health Check
    runs-on: ubuntu-latest
    needs: [echokit-server-deploy, integration-tests, e2e-tests]
    if: always() && (needs.echokit-server-deploy.result == 'success' && needs.integration-tests.result == 'success' && needs.e2e-tests.result == 'success')
    steps:
      - name: Create deployment status
        run: |
          echo "âœ… æ‰€æœ‰é›†æˆæµ‹è¯•é€šè¿‡"
          echo "ğŸ“Š æµ‹è¯•ç»Ÿè®¡:"
          echo "  - EchoKit Server éƒ¨ç½²: âœ… é€šè¿‡ (å¯åŠ¨æ—¶é—´: ${{ needs.echokit-server-deploy.outputs.echokit-startup-time }}ç§’)"
          echo "  - æ„å»ºæµ‹è¯•: âœ… é€šè¿‡"
          echo "  - é›†æˆæµ‹è¯•: âœ… é€šè¿‡"
          echo "  - ç«¯åˆ°ç«¯æµ‹è¯•: âœ… é€šè¿‡"
          echo ""
          echo "ğŸš€ Echo System å‡†å¤‡å°±ç»ªï¼Œå¯ä»¥éƒ¨ç½²ï¼"
          echo "ğŸ“ EchoKit Server å·²åˆ‡æ¢ä¸º Docker Hub é•œåƒ: secondstate/echokit:latest-server-vad"

  # æ¸…ç†å·¥ä½œæµ
  cleanup:
    name: Cleanup Resources
    runs-on: ubuntu-latest
    needs: [integration-tests, e2e-tests, deployment-check]
    if: always()
    steps:
      - name: Cleanup test resources
        run: |
          echo "æ¸…ç†æµ‹è¯•èµ„æº..."
          # æ¸…ç†å¯èƒ½æ®‹ç•™çš„å®¹å™¨
          docker system prune -f || true
          echo "æ¸…ç†å®Œæˆ"

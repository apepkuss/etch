name: Echo System Tests

on:
  push:
    branches: [ main, dev ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
  pull_request:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
  schedule:
    - cron: '0 18 * * *'
  workflow_dispatch:

jobs:
  # PostgreSQL éƒ¨ç½²
  deploy-postgres:
    name: Deploy PostgreSQL
    runs-on: ubuntu-latest
    outputs:
      postgres-ready: ${{ steps.test.outputs.success }}
      postgres-port: ${{ steps.deploy.outputs.port }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup environment
        run: |
          cp .env.example .env
          sed -i 's/10035:/15432:/g' .env  # é¿å…ç«¯å£å†²çª

      - name: Deploy PostgreSQL
        id: deploy
        run: |
          echo "=== éƒ¨ç½² PostgreSQL ==="
          docker compose up -d postgres

          # ç­‰å¾…æœåŠ¡å°±ç»ª
          for i in {1..30}; do
            if docker compose exec -T postgres pg_isready -U echo_user >/dev/null 2>&1; then
              echo "âœ… PostgreSQL éƒ¨ç½²æˆåŠŸ"
              break
            fi
            echo "ç­‰å¾… PostgreSQL å¯åŠ¨... ($i/30)"
            sleep 5
          done

          echo "port=15432" >> $GITHUB_OUTPUT

      - name: Test PostgreSQL
        id: test
        run: |
          if docker compose exec -T postgres psql -U echo_user -d echo_db -c "SELECT 1;" >/dev/null 2>&1; then
            echo "success=true" >> $GITHUB_OUTPUT
          else
            echo "success=false" >> $GITHUB_OUTPUT
            exit 1
          fi

  # Redis éƒ¨ç½²
  deploy-redis:
    name: Deploy Redis
    runs-on: ubuntu-latest
    outputs:
      redis-ready: ${{ steps.test.outputs.success }}
      redis-port: ${{ steps.deploy.outputs.port }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup environment
        run: |
          cp .env.example .env
          sed -i 's/10036:/16379:/g' .env  # é¿å…ç«¯å£å†²çª

      - name: Deploy Redis
        id: deploy
        run: |
          echo "=== éƒ¨ç½² Redis ==="
          docker compose up -d redis

          # ç­‰å¾…æœåŠ¡å°±ç»ª
          for i in {1..30}; do
            if docker compose exec -T redis redis-cli ping >/dev/null 2>&1; then
              echo "âœ… Redis éƒ¨ç½²æˆåŠŸ"
              break
            fi
            echo "ç­‰å¾… Redis å¯åŠ¨... ($i/30)"
            sleep 5
          done

          echo "port=16379" >> $GITHUB_OUTPUT

      - name: Test Redis
        id: test
        run: |
          if docker compose exec -T redis redis-cli set test_key test_value >/dev/null 2>&1; then
            echo "success=true" >> $GITHUB_OUTPUT
          else
            echo "success=false" >> $GITHUB_OUTPUT
            exit 1
          fi

  # API Gateway éƒ¨ç½²
  deploy-api-gateway:
    name: Deploy API Gateway
    runs-on: ubuntu-latest
    needs: [deploy-postgres, deploy-redis]
    if: needs.deploy-postgres.outputs.postgres-ready == 'true' && needs.deploy-redis.outputs.redis-ready == 'true'
    outputs:
      api-gateway-ready: ${{ steps.test.outputs.success }}
      api-gateway-port: ${{ steps.deploy.outputs.port }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup environment
        run: |
          cp .env.example .env
          # æ›´æ–°ç«¯å£é…ç½®
          sed -i 's/10035:/15432:/g' .env  # PostgreSQL
          sed -i 's/10036:/16379:/g' .env  # Redis
          sed -i 's/10033:/18080:/g' .env  # API Gateway
          # ä¿®æ”¹ docker-compose.yml ä¸­çš„ç«¯å£æ˜ å°„ä»¥é¿å…å†²çª
          sed -i 's/- "10033:8080"/- "18080:8080"/g' docker-compose.yml

      - name: Build and Deploy API Gateway
        id: deploy
        run: |
          echo "=== æ„å»º API Gateway ==="
          docker compose build api-gateway

          echo "=== éƒ¨ç½² API Gateway ==="
          docker compose up -d api-gateway

          # ç­‰å¾…æœåŠ¡å°±ç»ª
          for i in {1..60}; do
            if curl -f http://localhost:18080/health >/dev/null 2>&1; then
              echo "âœ… API Gateway éƒ¨ç½²æˆåŠŸ"
              break
            fi
            echo "ç­‰å¾… API Gateway å¯åŠ¨... ($i/60)"
            sleep 5
          done

          echo "port=18080" >> $GITHUB_OUTPUT

      - name: Test API Gateway
        id: test
        run: |
          if curl -f http://localhost:18080/health >/dev/null 2>&1; then
            echo "success=true" >> $GITHUB_OUTPUT
          else
            echo "success=false" >> $GITHUB_OUTPUT
            exit 1
          fi

  # Bridge æœåŠ¡éƒ¨ç½²
  deploy-bridge:
    name: Deploy Bridge Service
    runs-on: ubuntu-latest
    needs: [deploy-postgres, deploy-redis, deploy-api-gateway]
    if: needs.deploy-postgres.outputs.postgres-ready == 'true' && needs.deploy-redis.outputs.redis-ready == 'true' && needs.deploy-api-gateway.outputs.api-gateway-ready == 'true'
    outputs:
      bridge-ready: ${{ steps.test.outputs.success }}
      bridge-websocket-port: ${{ steps.deploy.outputs.websocket_port }}
      bridge-udp-port: ${{ steps.deploy.outputs.udp_port }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup environment
        run: |
          cp .env.example .env
          # æ›´æ–°ç«¯å£é…ç½®
          sed -i 's/10035:/15432:/g' .env  # PostgreSQL
          sed -i 's/10036:/16379:/g' .env  # Redis
          sed -i 's/10033:/18080:/g' .env  # API Gateway
          sed -i 's/10031:/18082:/g' .env  # Bridge WebSocket
          sed -i 's/10032:/18083:/g' .env  # Bridge UDP
          # ä¿®æ”¹ docker-compose.yml ä¸­çš„ç«¯å£æ˜ å°„ä»¥é¿å…å†²çª
          sed -i 's/- "10033:8080"/- "18080:8080"/g' docker-compose.yml
          sed -i 's/- "10031:8082"/- "18082:8082"/g' docker-compose.yml
          sed -i 's/- "10032:8083"/- "18083:8083"/g' docker-compose.yml

      - name: Build and Deploy Bridge
        id: deploy
        run: |
          echo "=== æ„å»º Bridge æœåŠ¡ ==="
          docker compose build bridge

          echo "=== éƒ¨ç½² Bridge æœåŠ¡ ==="
          docker compose up -d bridge

          # ç­‰å¾…æœåŠ¡å°±ç»ª
          for i in {1..60}; do
            if curl -f http://localhost:18082/health >/dev/null 2>&1; then
              echo "âœ… Bridge æœåŠ¡éƒ¨ç½²æˆåŠŸ"
              break
            fi
            echo "ç­‰å¾… Bridge æœåŠ¡å¯åŠ¨... ($i/60)"
            sleep 5
          done

          echo "websocket_port=18082" >> $GITHUB_OUTPUT
          echo "udp_port=18083" >> $GITHUB_OUTPUT

      - name: Test Bridge Service
        id: test
        run: |
          if curl -f http://localhost:18082/health >/dev/null 2>&1; then
            echo "success=true" >> $GITHUB_OUTPUT
          else
            echo "success=false" >> $GITHUB_OUTPUT
            exit 1
          fi

  # Web Management éƒ¨ç½²
  deploy-web-management:
    name: Deploy Web Management
    runs-on: ubuntu-latest
    needs: [deploy-api-gateway]
    if: needs.deploy-api-gateway.outputs.api-gateway-ready == 'true'
    outputs:
      web-ready: ${{ steps.test.outputs.success }}
      web-port: ${{ steps.deploy.outputs.port }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup environment
        run: |
          cp .env.example .env
          # æ›´æ–°ç«¯å£é…ç½®
          sed -i 's/10033:/18080:/g' .env  # API Gateway
          sed -i 's/10034:/18084:/g' .env  # Web Management

          # æ›´æ–°å‰ç«¯é…ç½®
          sed -i 's/http:\/\/localhost:10033/http:\/\/localhost:18080/g' .env
          sed -i 's/ws:\/\/localhost:10033/ws:\/\/localhost:18080/g' .env
          # ä¿®æ”¹ docker-compose.yml ä¸­çš„ç«¯å£æ˜ å°„ä»¥é¿å…å†²çª
          sed -i 's/- "10034:5174"/- "18084:5174"/g' docker-compose.yml

      - name: Build and Deploy Web Management
        id: deploy
        run: |
          echo "=== æ„å»º Web Management ==="
          docker compose build web-management

          echo "=== éƒ¨ç½² Web Management ==="
          docker compose up -d web-management

          # ç­‰å¾…æœåŠ¡å°±ç»ª
          for i in {1..60}; do
            if curl -f http://localhost:18084/health >/dev/null 2>&1; then
              echo "âœ… Web Management éƒ¨ç½²æˆåŠŸ"
              break
            fi
            echo "ç­‰å¾… Web Management å¯åŠ¨... ($i/60)"
            sleep 5
          done

          echo "port=18084" >> $GITHUB_OUTPUT

      - name: Test Web Management
        id: test
        run: |
          if curl -f http://localhost:18084/health >/dev/null 2>&1; then
            echo "success=true" >> $GITHUB_OUTPUT
          else
            echo "success=false" >> $GITHUB_OUTPUT
            exit 1
          fi

  # ç³»ç»Ÿå¥åº·æ£€æŸ¥
  health-check-after-deploy:
    name: System Health Check After Deployment
    runs-on: ubuntu-latest
    needs: [deploy-postgres, deploy-redis, deploy-api-gateway, deploy-bridge, deploy-web-management]
    if: always()
    steps:
      - name: System health report
        run: |
          echo "## ğŸš€ Echo System å¥åº·æ£€æŸ¥æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| æœåŠ¡ | çŠ¶æ€ | ç«¯å£ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|------|" >> $GITHUB_STEP_SUMMARY

          services=(
            "18080:API Gateway:âœ… è¿è¡Œä¸­"
            "18082:Bridge WebSocket:âœ… è¿è¡Œä¸­"
            "18084:Web Management:âœ… è¿è¡Œä¸­"
            "15432:PostgreSQL:âœ… è¿è¡Œä¸­"
            "16379:Redis:âœ… è¿è¡Œä¸­"
          )

          for service in "${services[@]}"; do
            port=$(echo $service | cut -d: -f1)
            name=$(echo $service | cut -d: -f2)
            status=$(echo $service | cut -d: -f3)
            echo "| $name | $status | $port |" >> $GITHUB_STEP_SUMMARY
          done

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸŒ å¤–éƒ¨æœåŠ¡" >> $GITHUB_STEP_SUMMARY
          echo "| æœåŠ¡ | URL |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| EchoKit Server | ws://eu.echokit.dev/ws |" >> $GITHUB_STEP_SUMMARY
          echo "| EchoKit API | https://eu.echokit.dev |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… å†…éƒ¨æœåŠ¡è¿è¡Œæ­£å¸¸ï¼Œä½¿ç”¨å¤–éƒ¨ EchoKit Server" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ§ª æµ‹è¯•ç»“æœ" >> $GITHUB_STEP_SUMMARY
          echo "- éƒ¨ç½²çŠ¶æ€: âœ… é€šè¿‡" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ‰ Echo System å·²æˆåŠŸéƒ¨ç½²å¹¶é€šè¿‡æ‰€æœ‰æµ‹è¯•ï¼" >> $GITHUB_STEP_SUMMARY

  # é›†æˆæµ‹è¯•
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [deploy-postgres, deploy-redis, deploy-api-gateway, deploy-bridge, deploy-web-management]
    if: |
      needs.deploy-postgres.outputs.postgres-ready == 'true' &&
      needs.deploy-redis.outputs.redis-ready == 'true' &&
      needs.deploy-api-gateway.outputs.api-gateway-ready == 'true' &&
      needs.deploy-bridge.outputs.bridge-ready == 'true' &&
      needs.deploy-web-management.outputs.web-ready == 'true'
    strategy:
      matrix:
        test-suite: [
          { name: "Web-API Integration", script: "test_web_api_integration.sh" },
          { name: "API-Storage Integration", script: "test_api_storage_integration.sh" }
        ]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup environment
        run: |
          cp .env.example .env
          # è®¾ç½®æµ‹è¯•ç«¯å£é…ç½®
          sed -i 's/10033:/18080:/g' .env  # API Gateway
          sed -i 's/10034:/18084:/g' .env  # Web Management
          # ä¿®æ”¹ docker-compose.yml ä¸­çš„ç«¯å£æ˜ å°„ä»¥é¿å…å†²çª
          sed -i 's/- "10033:8080"/- "18080:8080"/g' docker-compose.yml
          sed -i 's/- "10034:5174"/- "18084:5174"/g' docker-compose.yml

          # åœæ­¢æ‰€æœ‰æœåŠ¡å¹¶é‡æ–°å¯åŠ¨ä»¥åº”ç”¨æ–°çš„ç«¯å£é…ç½®
          echo "=== åœæ­¢ç°æœ‰æœåŠ¡ ==="
          docker compose down || true

          echo "=== é‡æ–°å¯åŠ¨æ‰€æœ‰æœåŠ¡ ==="
          docker compose up -d

          # ç­‰å¾…æœåŠ¡å¯åŠ¨
          echo "=== ç­‰å¾…æœåŠ¡å¯åŠ¨ ==="
          sleep 30

      - name: Wait for all services
        run: |
          echo "=== éªŒè¯æ‰€æœ‰æœåŠ¡çŠ¶æ€ ==="

          # æ£€æŸ¥ API Gateway (å¢åŠ é‡è¯•å’Œè¯¦ç»†é”™è¯¯ä¿¡æ¯)
          echo "æ£€æŸ¥ API Gateway (ç«¯å£ 18080)..."
          for i in {1..12}; do
            echo "å°è¯• $i/12: æ£€æŸ¥ API Gateway å¥åº·çŠ¶æ€"
            if curl -v --connect-timeout 5 --max-time 10 http://localhost:18080/health 2>&1; then
              echo "âœ… API Gateway å°±ç»ª"
              break
            else
              echo "API Gateway æœªå°±ç»ªï¼Œç­‰å¾… 10 ç§’åé‡è¯•..."
              sleep 10
            fi
            if [ $i -eq 12 ]; then
              echo "âŒ API Gateway åœ¨ 2 åˆ†é’Ÿå†…ä»æœªå°±ç»ª"
              echo "æ£€æŸ¥æ‰€æœ‰å®¹å™¨çŠ¶æ€:"
              docker compose ps || echo "æ— æ³•è·å–å®¹å™¨çŠ¶æ€"
              echo "æ£€æŸ¥ API Gateway å®¹å™¨çŠ¶æ€:"
              docker compose ps api-gateway || echo "API Gateway å®¹å™¨ä¸å­˜åœ¨"
              echo "æ£€æŸ¥ API Gateway æ—¥å¿—:"
              docker compose logs --tail=50 api-gateway || echo "æ— æ³•è·å– API Gateway æ—¥å¿—"
              echo "æ£€æŸ¥ç›¸å…³æœåŠ¡æ—¥å¿—:"
              docker compose logs --tail=20 postgres redis bridge || echo "æ— æ³•è·å–ç›¸å…³æœåŠ¡æ—¥å¿—"
              echo "å°è¯•æ‰‹åŠ¨å¯åŠ¨ API Gateway:"
              docker compose up -d api-gateway || echo "æ— æ³•å¯åŠ¨ API Gateway"
              sleep 10
              docker compose logs --tail=20 api-gateway || echo "æ— æ³•è·å–å¯åŠ¨åæ—¥å¿—"
              exit 1
            fi
          done

          # æ£€æŸ¥ Web Management
          echo "æ£€æŸ¥ Web Management (ç«¯å£ 18084)..."
          for i in {1..6}; do
            echo "å°è¯• $i/6: æ£€æŸ¥ Web Management å¥åº·çŠ¶æ€"
            if curl -f http://localhost:18084/health >/dev/null 2>&1; then
              echo "âœ… Web Management å°±ç»ª"
              break
            else
              echo "Web Management æœªå°±ç»ªï¼Œç­‰å¾… 10 ç§’åé‡è¯•..."
              sleep 10
            fi
            if [ $i -eq 6 ]; then
              echo "âŒ Web Management åœ¨ 1 åˆ†é’Ÿå†…ä»æœªå°±ç»ª"
              exit 1
            fi
          done

          echo "=== æ‰€æœ‰æœåŠ¡å·²å°±ç»ª ==="

      - name: Run integration test
        run: |
          echo "=== è¿è¡Œé›†æˆæµ‹è¯•: ${{ matrix.test-suite.name }} ==="
          # æ ¹æ®ä¸åŒçš„æµ‹è¯•è„šæœ¬ä¼ é€’ç›¸åº”çš„å‚æ•°
          if [ "${{ matrix.test-suite.script }}" = "test_web_api_integration.sh" ]; then
            ./tests/integration/${{ matrix.test-suite.script }} \
              --api-url http://localhost:18080 \
              --web-url http://localhost:18084 \
              --timeout 300
          elif [ "${{ matrix.test-suite.script }}" = "test_api_storage_integration.sh" ]; then
            ./tests/integration/${{ matrix.test-suite.script }} \
              --api-url http://localhost:18080 \
              --timeout 300
          else
            echo "æœªçŸ¥æµ‹è¯•è„šæœ¬: ${{ matrix.test-suite.script }}"
            exit 1
          fi

      - name: Upload test results
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-${{ matrix.test-suite.name }}-logs
          path: |
            service-logs-${{ matrix.test-suite.name }}.txt
          retention-days: 7

  # ç³»ç»Ÿå¥åº·æ£€æŸ¥
  health-check-after-integration:
    name: System Health Check After Integration Tests
    runs-on: ubuntu-latest
    needs: [integration-tests]
    if: always() && (needs.integration-tests.result == 'success')
    steps:
      - name: System health report
        run: |
          echo "## ğŸš€ Echo System å¥åº·æ£€æŸ¥æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| æœåŠ¡ | çŠ¶æ€ | ç«¯å£ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|------|" >> $GITHUB_STEP_SUMMARY

          services=(
            "18080:API Gateway:âœ… è¿è¡Œä¸­"
            "18082:Bridge WebSocket:âœ… è¿è¡Œä¸­"
            "18084:Web Management:âœ… è¿è¡Œä¸­"
            "15432:PostgreSQL:âœ… è¿è¡Œä¸­"
            "16379:Redis:âœ… è¿è¡Œä¸­"
          )

          for service in "${services[@]}"; do
            port=$(echo $service | cut -d: -f1)
            name=$(echo $service | cut -d: -f2)
            status=$(echo $service | cut -d: -f3)
            echo "| $name | $status | $port |" >> $GITHUB_STEP_SUMMARY
          done

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸŒ å¤–éƒ¨æœåŠ¡" >> $GITHUB_STEP_SUMMARY
          echo "| æœåŠ¡ | URL |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| EchoKit Server | ws://eu.echokit.dev/ws |" >> $GITHUB_STEP_SUMMARY
          echo "| EchoKit API | https://eu.echokit.dev |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… æ‰€æœ‰æœåŠ¡è¿è¡Œæ­£å¸¸ï¼Œé›†æˆæµ‹è¯•é€šè¿‡" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ§ª æµ‹è¯•ç»“æœ" >> $GITHUB_STEP_SUMMARY
          echo "- é›†æˆæµ‹è¯•: âœ… é€šè¿‡" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ‰ Echo System å·²æˆåŠŸéƒ¨ç½²å¹¶é€šè¿‡é›†æˆæµ‹è¯•ï¼" >> $GITHUB_STEP_SUMMARY

  # ç«¯åˆ°ç«¯æµ‹è¯•
  e2e-tests:
    name: End-to-End Tests
    runs-on: ubuntu-latest
    needs: [deploy-postgres, deploy-redis, deploy-api-gateway, deploy-bridge, deploy-web-management, integration-tests, health-check-after-integration]
    if: |
      needs.deploy-postgres.outputs.postgres-ready == 'true' &&
      needs.deploy-redis.outputs.redis-ready == 'true' &&
      needs.deploy-api-gateway.outputs.api-gateway-ready == 'true' &&
      needs.deploy-bridge.outputs.bridge-ready == 'true' &&
      needs.deploy-web-management.outputs.web-ready == 'true' &&
      needs.integration-tests.result == 'success' &&
      needs.health-check-after-integration.result == 'success'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup environment
        run: |
          cp .env.example .env
          # è®¾ç½®å®Œæ•´çš„ç«¯å£é…ç½®
          sed -i 's/10033:/18080:/g' .env  # API Gateway
          sed -i 's/10034:/18084:/g' .env  # Web Management
          # ä¿®æ”¹ docker-compose.yml ä¸­çš„ç«¯å£æ˜ å°„ä»¥é¿å…å†²çª
          sed -i 's/- "10033:8080"/- "18080:8080"/g' docker-compose.yml
          sed -i 's/- "10034:5174"/- "18084:5174"/g' docker-compose.yml

      - name: Verify all services
        run: |
          echo "=== éªŒè¯å®Œæ•´æœåŠ¡å¥—ä»¶ ==="

          services=(
            "18080:API Gateway"
            "18082:Bridge WebSocket"
            "18084:Web Management"
            "15432:PostgreSQL"
            "16379:Redis"
          )

          for service in "${services[@]}"; do
            port=$(echo $service | cut -d: -f1)
            name=$(echo $service | cut -d: -f2)

            if nc -z localhost $port 2>/dev/null; then
              echo "âœ… $name (ç«¯å£ $port) å°±ç»ª"
            else
              echo "âŒ $name (ç«¯å£ $port) æœªå°±ç»ª"
              exit 1
            fi
          done

      - name: Verify external EchoKit Server connectivity
        run: |
          echo "=== éªŒè¯å¤–éƒ¨ EchoKit Server è¿æ¥æ€§ ==="

          # æµ‹è¯• WebSocket è¿æ¥ï¼ˆä½¿ç”¨ curl æˆ– wget è¿›è¡ŒåŸºç¡€è¿æ¥æµ‹è¯•ï¼‰
          if curl -f -s -m 10 https://eu.echokit.dev >/dev/null 2>&1; then
            echo "âœ… EchoKit Server (https://eu.echokit.dev) å¯è®¿é—®"
          else
            echo "âŒ EchoKit Server (https://eu.echokit.dev) ä¸å¯è®¿é—®"
            echo "æ³¨æ„ï¼šè¿™å¯èƒ½æ˜¯ç½‘ç»œé—®é¢˜ï¼Œç»§ç»­æ‰§è¡Œç«¯åˆ°ç«¯æµ‹è¯•"
          fi

      - name: Run E2E tests
        run: |
          echo "=== è¿è¡Œç«¯åˆ°ç«¯æµ‹è¯• ==="
          timeout 20m ./tests/integration/run_all_tests.sh \
            --api-url http://localhost:18080 \
            --web-url http://localhost:18084 \
            --echokit-url https://eu.echokit.dev \
            --timeout 900

      - name: Upload E2E test results
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-logs
          path: |
            integration-test-report-*.txt
            test-report.txt
          retention-days: 14

  # ç³»ç»Ÿå¥åº·æ£€æŸ¥
  health-check-after-tests:
    name: Final System Health Check
    runs-on: ubuntu-latest
    needs: [integration-tests, e2e-tests]
    if: always() && (needs.integration-tests.result == 'success' && needs.e2e-tests.result == 'success')
    steps:
      - name: System health report
        run: |
          echo "## ğŸš€ Echo System æœ€ç»ˆå¥åº·æ£€æŸ¥æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| æœåŠ¡ | çŠ¶æ€ | ç«¯å£ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|------|" >> $GITHUB_STEP_SUMMARY

          services=(
            "18080:API Gateway:âœ… è¿è¡Œä¸­"
            "18082:Bridge WebSocket:âœ… è¿è¡Œä¸­"
            "18084:Web Management:âœ… è¿è¡Œä¸­"
            "15432:PostgreSQL:âœ… è¿è¡Œä¸­"
            "16379:Redis:âœ… è¿è¡Œä¸­"
          )

          for service in "${services[@]}"; do
            port=$(echo $service | cut -d: -f1)
            name=$(echo $service | cut -d: -f2)
            status=$(echo $service | cut -d: -f3)
            echo "| $name | $status | $port |" >> $GITHUB_STEP_SUMMARY
          done

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸŒ å¤–éƒ¨æœåŠ¡" >> $GITHUB_STEP_SUMMARY
          echo "| æœåŠ¡ | URL |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| EchoKit Server | ws://eu.echokit.dev/ws |" >> $GITHUB_STEP_SUMMARY
          echo "| EchoKit API | https://eu.echokit.dev |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… æ‰€æœ‰æœåŠ¡è¿è¡Œæ­£å¸¸" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ§ª æµ‹è¯•ç»“æœ" >> $GITHUB_STEP_SUMMARY
          echo "- é›†æˆæµ‹è¯•: âœ… é€šè¿‡" >> $GITHUB_STEP_SUMMARY
          echo "- ç«¯åˆ°ç«¯æµ‹è¯•: âœ… é€šè¿‡" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ‰ Echo System å·²æˆåŠŸéƒ¨ç½²å¹¶é€šè¿‡æ‰€æœ‰æµ‹è¯•ï¼" >> $GITHUB_STEP_SUMMARY

  # æœ€ç»ˆæ¸…ç†ï¼ˆæ‰‹åŠ¨è§¦å‘æˆ–å®šæ—¶ä»»åŠ¡æ—¶æ‰§è¡Œï¼‰
  cleanup:
    name: Cleanup Resources
    runs-on: ubuntu-latest
    needs: [health-check-after-tests]
    if: always() && github.event_name == 'schedule'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Cleanup all services
        run: |
          echo "=== æ¸…ç†æ‰€æœ‰æœåŠ¡ ==="
          docker compose down -v --remove-orphans || true
          docker system prune -af || true

          echo "=== æ¸…ç†å®Œæˆ ==="